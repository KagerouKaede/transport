<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºèƒ½è¿è¾“ç³»ç»Ÿåœ°å›¾</title>
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="style.css"/>
  <style></style>
</head>
<body>
  <!-- åœ°å›¾å®¹å™¨ -->
  <div id="container"></div>
  
  <!-- æ•°æ®æ›´æ–°æç¤º -->
  <div id="update-notification" class="update-notification">æ•°æ®å·²æ›´æ–°</div>
  
  <!-- æ§åˆ¶æŒ‰é’® - å·¦ä¸Š -->
  <div class="control-buttons">
    <button id="toggle-vehicle-panel" class="control-btn vehicle-btn">
      <span>ğŸšš è½¦è¾†åˆ—è¡¨åŠæŒ‡æ ‡</span>
      <span class="arrow">â–¼</span>
    </button>
    
    <button id="toggle-system-panel" class="control-btn system-btn">
      <span>ğŸ“Š ç³»ç»ŸæŒ‡æ ‡</span>
      <span class="arrow">â–¼</span>
    </button>
  </div>
  
  <!-- è½¦è¾†æŒ‡æ ‡æ•£ç‚¹å›¾æ¨¡å— - å³ä¸Š -->
  <div class="scatter-control">
    <button id="toggle-scatter-panel" class="scatter-btn">
      <span>ğŸ“ˆ è½¦è¾†æŒ‡æ ‡æ•£ç‚¹å›¾</span>
      <span class="arrow">â–¼</span>
    </button>
  </div>
  
  <!-- è½¦è¾†é¢æ¿ -->
  <div id="vehicle-panel" class="floating-panel vehicle-panel">
    <div class="panel-header">
      <button class="back-btn" id="vehicle-back-btn" title="è¿”å›åˆ—è¡¨">â†</button>
      <h3 class="panel-title">è½¦è¾†åˆ—è¡¨</h3>
      <button class="close-btn" id="close-vehicle-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <!-- è½¦è¾†åˆ—è¡¨è§†å›¾ -->
      <div id="vehicle-list-container" class="vehicle-list-container">
        <table class="vehicle-list-table" id="vehicle-list">
          <thead>
            <tr>
              <th>è½¦è¾†ID</th>
              <th>ç±»å‹</th>
              <th>çŠ¶æ€</th>
              <th>è¿è¾“æ¬¡æ•°</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <!-- è½¦è¾†è¯¦æƒ…è§†å›¾ -->
      <div id="vehicle-detail-container" class="vehicle-detail-container">
        <div class="vehicle-detail-header">
          <h3 id="vehicle-detail-title" class="vehicle-detail-title">
            <span>è½¦è¾†è¯¦æƒ…</span>
            <div id="vehicle-status-badge" class="vehicle-status">çŠ¶æ€</div>
          </h3>
        </div>
        
        <div class="vehicle-metrics-grid" id="vehicle-metrics-grid">
          <!-- æŒ‡æ ‡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç³»ç»ŸæŒ‡æ ‡é¢æ¿ -->
  <div id="system-panel" class="floating-panel system-panel">
    <div class="panel-header">
      <button class="back-btn" id="system-back-btn" title="è¿”å›æŒ‡æ ‡">â†</button>
      <h3 class="panel-title">ç³»ç»ŸæŒ‡æ ‡</h3>
      <button class="close-btn" id="close-system-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <!-- ç³»ç»ŸæŒ‡æ ‡è§†å›¾ -->
      <div id="system-metrics-container" class="system-metrics-container">
        <div class="system-metrics-grid" id="system-metrics-grid">
          <!-- ç³»ç»ŸæŒ‡æ ‡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- å›¾è¡¨å®¹å™¨ -->
        <div class="chart-container" id="system-chart-container">
          <div class="chart-header">
            <h3 id="chart-title" class="chart-title">ç³»ç»Ÿæ€»ä»£ä»·å˜åŒ–</h3>
            <div class="chart-actions">
              <button id="toggle-chart-type" class="chart-btn">åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾</button>
            </div>
          </div>
          <canvas id="system-chart"></canvas>
        </div>
      </div>
      
      <!-- å•ä¸ªæŒ‡æ ‡å›¾è¡¨è§†å›¾ -->
      <div id="metric-chart-container" class="chart-container" style="display: none;">
        <div class="chart-header">
          <h3 id="metric-chart-title" class="chart-title">æŒ‡æ ‡è¯¦æƒ…</h3>
          <div class="chart-actions">
            <button id="toggle-metric-chart-type" class="chart-btn">åˆ‡æ¢å›¾è¡¨ç±»å‹</button>
          </div>
        </div>
        <canvas id="metric-chart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- æ•£ç‚¹å›¾é¢æ¿ -->
  <div id="scatter-panel" class="floating-panel scatter-panel">
    <div class="panel-header">
      <h3 class="panel-title">è½¦è¾†æŒ‡æ ‡æ•£ç‚¹å›¾</h3>
      <button class="close-btn" id="close-scatter-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <div class="scatter-metrics-container">
        <button class="scatter-metric-btn active" data-metric="avgCost">è½¦è¾†å‘¨æœŸå¹³å‡ä»£ä»·</button>
        <button class="scatter-metric-btn" data-metric="effectiveTimeRatio">æœ‰æ•ˆè¿æ—¶æ¯”</button>
        <button class="scatter-metric-btn" data-metric="effectiveLoadRatio">æœ‰æ•ˆè¿è½½æ¯”</button>
        <button class="scatter-metric-btn" data-metric="idleRatio">è½¦è¾†ç©ºé—²æ¯”</button>
      </div>
      
      <div class="chart-container" id="scatter-chart-container" style="display: block; height: 350px;">
        <div class="chart-header">
          <h3 id="scatter-chart-title" class="chart-title">è½¦è¾†å‘¨æœŸå¹³å‡ä»£ä»·æ•£ç‚¹å›¾</h3>
          <div class="chart-actions">
            <button id="reset-scatter-zoom" class="chart-btn">é‡ç½®è§†å›¾</button>
          </div>
        </div>
        <canvas id="scatter-chart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- åº•éƒ¨æŒ‰é’® -->
  <div class="bottom-buttons">
    <button id="open-comparison" class="bottom-btn comparison-btn">
      <span>ğŸ“Š</span>
      <span>æ‰“å¼€å¯¹æ¯”å›¾</span>
    </button>
  </div>
  
  <!-- æ¨¡æ€æ¡† -->
  <div id="vehicle-modal">
    <h3 id="modal-title">è½¦è¾†è¯¦æƒ…</h3>
    <div id="modal-body"></div>
    <div style="text-align: right; margin-top: 20px;">
      <button onclick="document.getElementById('vehicle-modal').style.display='none'">
        å…³é—­
      </button>
    </div>
  </div>

  <script type="text/javascript">
    window._AMapSecurityConfig = {
      securityJsCode:"9858defc87670662758db011c95df7ac"
    };
  </script>
  
  <!-- ä¸»JavaScriptæ–‡ä»¶ -->
  <script type="module" src="./map/main.js"></script>
  
  <script type="module">
  // å…¨å±€å˜é‡
  let map;
  let vehicles = [];
  let systemMetricsHistory = {
    totalCost: [],
    totalTransportCount: [],
    totalWeight: [],
    totalEmptyMileage: [],
    avgUtilization: []
  };
  let periodLabels = [];
  let currentPeriod = 1;
  
  // ç³»ç»ŸæŒ‡æ ‡å®šä¹‰
  const SYSTEM_METRICS = [
    { id: 'totalCost', name: 'æ€»ä»£ä»·', unit: '', color: 'rgba(155, 89, 182, 0.8)', borderColor: '#9b59b6' },
    { id: 'totalTransportCount', name: 'æ€»è¿è¾“æ¬¡æ•°', unit: 'æ¬¡', color: 'rgba(52, 152, 219, 0.8)', borderColor: '#3498db' },
    { id: 'totalWeight', name: 'æ€»è¿è¾“é‡é‡', unit: 'KG', color: 'rgba(46, 204, 113, 0.8)', borderColor: '#2ecc71' },
    { id: 'totalEmptyMileage', name: 'æ€»ç©ºé©¶é‡Œç¨‹', unit: 'km', color: 'rgba(231, 76, 60, 0.8)', borderColor: '#e74c3c' },
    { id: 'avgUtilization', name: 'å¹³å‡åˆ©ç”¨ç‡', unit: '%', color: 'rgba(241, 196, 15, 0.8)', borderColor: '#f1c40f' }
  ];
  
  // è½¦è¾†æŒ‡æ ‡å®šä¹‰
  const VEHICLE_METRICS = [
    { id: 'completeCount', name: 'è¿è¾“æ¬¡æ•°', unit: 'æ¬¡' },
    { id: 'totalWeight', name: 'æ€»è¿è¾“é‡é‡', unit: 'KG' },
    { id: 'emptyDistance', name: 'ç©ºé©¶é‡Œç¨‹', unit: 'km' },
    { id: 'totalDistance', name: 'æ€»è¡Œé©¶é‡Œç¨‹', unit: 'km' },
    { id: 'busyTime', name: 'å·¥ä½œæ—¶é—´', unit: 'åˆ†é’Ÿ' },
    { id: 'idleTime', name: 'ç©ºé—²æ—¶é—´', unit: 'åˆ†é’Ÿ' },
    { id: 'utilization', name: 'åˆ©ç”¨ç‡', unit: '%' },
    { id: 'idleRate', name: 'ç©ºé—²æ¯”', unit: '%' },
    { id: 'accWastedLoad', name: 'æµªè´¹è½½é‡', unit: 'KG' },
    { id: 'cost', name: 'å½“å‰æˆæœ¬', unit: '' },
    { id: 'totalCost', name: 'ç´¯è®¡æˆæœ¬', unit: '' }
  ];
  
  // æ•£ç‚¹å›¾æŒ‡æ ‡å®šä¹‰
  const SCATTER_METRICS = {
    avgCost: {
      name: 'è½¦è¾†å‘¨æœŸå¹³å‡ä»£ä»·',
      xLabel: 'ä»¿çœŸå‘¨æœŸæ•°',
      yLabel: 'å•è½¦æ€»ä»£ä»·/å‘¨æœŸæ•°',
      calculate: (vehicle, currentPeriod) => {
        const totalCost = vehicle.metrics.totalCost || 0;
        return {
          x: currentPeriod,
          y: currentPeriod > 0 ? totalCost / currentPeriod : 0
        };
      }
    },
    effectiveTimeRatio: {
      name: 'æœ‰æ•ˆè¿æ—¶æ¯”',
      xLabel: 'è¡Œé©¶æ—¶é•¿',
      yLabel: 'è¿è´§è¡Œé©¶æ—¶é•¿/è¡Œé©¶æ—¶é•¿',
      calculate: (vehicle) => {
        const busyTime = vehicle.metrics.busyTime || 0;
        // å‡è®¾è¿è´§è¡Œé©¶æ—¶é•¿å æ€»è¡Œé©¶æ—¶é•¿çš„70%
        const transportingTime = busyTime * 0.7;
        return {
          x: busyTime,
          y: busyTime > 0 ? transportingTime / busyTime : 0
        };
      }
    },
    effectiveLoadRatio: {
      name: 'æœ‰æ•ˆè¿è½½æ¯”',
      xLabel: 'æœ€å¤§è½½é‡',
      yLabel: 'å½“å‰è½½é‡/æœ€å¤§è½½é‡',
      calculate: (vehicle) => {
        const totalWeight = vehicle.metrics.totalWeight || 0;
        const maxLoad = 1000; // å‡è®¾æœ€å¤§è½½é‡ä¸º1000
        return {
          x: maxLoad,
          y: maxLoad > 0 ? totalWeight / maxLoad : 0
        };
      }
    },
    idleRatio: {
      name: 'è½¦è¾†ç©ºé—²æ¯”',
      xLabel: 'ä»¿çœŸæ—¶é•¿',
      yLabel: 'ç©ºé—²æ—¶é•¿/ä»¿çœŸæ—¶é•¿',
      calculate: (vehicle) => {
        const idleTime = vehicle.metrics.idleTime || 0;
        const busyTime = vehicle.metrics.busyTime || 0;
        const totalTime = idleTime + busyTime;
        return {
          x: totalTime,
          y: totalTime > 0 ? idleTime / totalTime : 0
        };
      }
    }
  };
  
  // çŠ¶æ€æ˜ å°„
  const STATUS_MAP = {
    "TRANSPORTING": { text: 'è¿è´§è¡Œé©¶', class: 'status-transporting', icon: 'ğŸšš' },
    "AVAILABLE": { text: 'ç©ºé—²', class: 'status-available', icon: 'ğŸŸ¢' },
    "UNLOADING": { text: 'å¸è´§', class: 'status-unloading', icon: 'ğŸ“¦' },
    "FREEZE": { text: 'åœè½¦ç­‰å¾…', class: 'status-freeze', icon: 'â¸ï¸' },
    "LOADING": { text: 'è£…è´§', class: 'status-loading', icon: 'ğŸ“¥' },
    "ORDER_TAKEN": { text: 'æ¥å•è¡Œé©¶', class: 'status-order-taken', icon: 'ğŸ›£ï¸' }
  };
  
  // å›¾è¡¨å®ä¾‹
  let systemChart = null;
  let metricChart = null;
  let scatterChart = null;
  let currentChartType = 'bar';
  let currentMetricChartType = 'bar';
  let currentMetricId = 'totalCost';
  let currentScatterMetric = 'avgCost';
  
  // DOMå…ƒç´ 
  const toggleVehiclePanelBtn = document.getElementById('toggle-vehicle-panel');
  const toggleSystemPanelBtn = document.getElementById('toggle-system-panel');
  const toggleScatterPanelBtn = document.getElementById('toggle-scatter-panel');
  const vehiclePanel = document.getElementById('vehicle-panel');
  const systemPanel = document.getElementById('system-panel');
  const scatterPanel = document.getElementById('scatter-panel');
  const closeVehiclePanelBtn = document.getElementById('close-vehicle-panel');
  const closeSystemPanelBtn = document.getElementById('close-system-panel');
  const closeScatterPanelBtn = document.getElementById('close-scatter-panel');
  const vehicleBackBtn = document.getElementById('vehicle-back-btn');
  const systemBackBtn = document.getElementById('system-back-btn');
  const vehicleListContainer = document.getElementById('vehicle-list-container');
  const vehicleDetailContainer = document.getElementById('vehicle-detail-container');
  const systemMetricsContainer = document.getElementById('system-metrics-container');
  const metricChartContainer = document.getElementById('metric-chart-container');
  const systemChartContainer = document.getElementById('system-chart-container');
  const scatterChartContainer = document.getElementById('scatter-chart-container');
  const updateNotification = document.getElementById('update-notification');
  
  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    initUI();
    initCharts();
    initScatterPanel();
    fetchDashboardData();
    setInterval(fetchDashboardData, 5000);
    
    // åˆå§‹åŒ–åœ°å›¾
    if (typeof AMap !== 'undefined') {
      initMap();
    }
  });
  
  // åˆå§‹åŒ–åœ°å›¾
  function initMap() {
    map = new AMap.Map('container', {
      zoom: 12,
      center: [104.06, 30.67],
      viewMode: '3D',
      pitch: 50,
      rotation: -15,
      mapStyle: 'amap://styles/dark',
      features: ['bg', 'road', 'building'],
      showLabel: true
    });
    
    // æ·»åŠ æ§ä»¶
    map.addControl(new AMap.Scale());
    map.addControl(new AMap.ToolBar({ position: 'RB' }));
  }
  
  // åˆå§‹åŒ–UI
  function initUI() {
    // è½¦è¾†é¢æ¿æ§åˆ¶
    toggleVehiclePanelBtn.addEventListener('click', function() {
      const isActive = this.classList.contains('active');
      
      if (isActive) {
        hideVehiclePanel();
      } else {
        showVehiclePanel();
      }
    });
    
    closeVehiclePanelBtn.addEventListener('click', hideVehiclePanel);
    
    // ç³»ç»Ÿé¢æ¿æ§åˆ¶
    toggleSystemPanelBtn.addEventListener('click', function() {
      const isActive = this.classList.contains('active');
      
      if (isActive) {
        hideSystemPanel();
      } else {
        showSystemPanel();
      }
    });
    
    closeSystemPanelBtn.addEventListener('click', hideSystemPanel);
    
    // è¿”å›æŒ‰é’®
    vehicleBackBtn.addEventListener('click', function() {
      showVehicleList();
    });
    
    systemBackBtn.addEventListener('click', function() {
      showSystemMetrics();
    });
    
    // å¯¹æ¯”å›¾æŒ‰é’®
    document.getElementById('open-comparison').addEventListener('click', function() {
      window.open('comparison.html', '_blank');
    });
    
    // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­é¢æ¿
    document.getElementById('container').addEventListener('click', function(e) {
      if (!vehiclePanel.contains(e.target) && !systemPanel.contains(e.target) && 
          !scatterPanel.contains(e.target) && !toggleVehiclePanelBtn.contains(e.target) && 
          !toggleSystemPanelBtn.contains(e.target) && !toggleScatterPanelBtn.contains(e.target)) {
        hideVehiclePanel();
        hideSystemPanel();
        hideScatterPanel();
      }
    });
  }
  
  // åˆå§‹åŒ–æ•£ç‚¹å›¾é¢æ¿
  function initScatterPanel() {
    // æ•£ç‚¹å›¾é¢æ¿æ§åˆ¶
    toggleScatterPanelBtn.addEventListener('click', function() {
      const isActive = this.classList.contains('active');
      
      if (isActive) {
        hideScatterPanel();
      } else {
        showScatterPanel();
      }
    });
    
    closeScatterPanelBtn.addEventListener('click', hideScatterPanel);
    
    // æŒ‡æ ‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.scatter-metric-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.scatter-metric-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        currentScatterMetric = this.dataset.metric;
        updateScatterChart();
        
        // æ›´æ–°å›¾è¡¨æ ‡é¢˜
        document.getElementById('scatter-chart-title').textContent = 
          SCATTER_METRICS[currentScatterMetric].name;
      });
    });
    
    // é‡ç½®è§†å›¾æŒ‰é’®
    document.getElementById('reset-scatter-zoom').addEventListener('click', function() {
      if (scatterChart) {
        scatterChart.resetZoom();
      }
    });
  }
  
  // æ˜¾ç¤º/éšè—é¢æ¿å‡½æ•°
  function showVehiclePanel() {
    vehiclePanel.style.display = 'block';
    toggleVehiclePanelBtn.classList.add('active');
    toggleVehiclePanelBtn.querySelector('.arrow').textContent = 'â–²';
  }
  
  function hideVehiclePanel() {
    vehiclePanel.style.display = 'none';
    toggleVehiclePanelBtn.classList.remove('active');
    toggleVehiclePanelBtn.querySelector('.arrow').textContent = 'â–¼';
  }
  
  function showSystemPanel() {
    systemPanel.style.display = 'block';
    toggleSystemPanelBtn.classList.add('active');
    toggleSystemPanelBtn.querySelector('.arrow').textContent = 'â–²';
  }
  
  function hideSystemPanel() {
    systemPanel.style.display = 'none';
    toggleSystemPanelBtn.classList.remove('active');
    toggleSystemPanelBtn.querySelector('.arrow').textContent = 'â–¼';
  }
  
  function showScatterPanel() {
    scatterPanel.style.display = 'block';
    toggleScatterPanelBtn.classList.add('active');
    toggleScatterPanelBtn.querySelector('.arrow').textContent = 'â–²';
  }
  
  function hideScatterPanel() {
    scatterPanel.style.display = 'none';
    toggleScatterPanelBtn.classList.remove('active');
    toggleScatterPanelBtn.querySelector('.arrow').textContent = 'â–¼';
  }
  
  // æ˜¾ç¤ºè½¦è¾†åˆ—è¡¨
  function showVehicleList() {
    vehicleListContainer.style.display = 'block';
    vehicleDetailContainer.style.display = 'none';
    vehicleBackBtn.style.display = 'none';
    document.querySelector('.vehicle-panel .panel-title').textContent = 'è½¦è¾†åˆ—è¡¨';
  }
  
  // æ˜¾ç¤ºè½¦è¾†è¯¦æƒ…
  function showVehicleDetail(vehicle) {
    vehicleListContainer.style.display = 'none';
    vehicleDetailContainer.style.display = 'block';
    vehicleBackBtn.style.display = 'block';
    document.querySelector('.vehicle-panel .panel-title').textContent = `è½¦è¾† ${vehicle.UUID}`;
    
    // æ›´æ–°è½¦è¾†è¯¦æƒ…
    updateVehicleDetail(vehicle);
  }
  
  // æ˜¾ç¤ºç³»ç»ŸæŒ‡æ ‡
  function showSystemMetrics() {
    systemMetricsContainer.style.display = 'block';
    metricChartContainer.style.display = 'none';
    systemChartContainer.classList.add('active');
    systemBackBtn.style.display = 'none';
    document.querySelector('.system-panel .panel-title').textContent = 'ç³»ç»ŸæŒ‡æ ‡';
  }
  
  // æ˜¾ç¤ºæŒ‡æ ‡å›¾è¡¨
  function showMetricChart(metricId) {
    systemMetricsContainer.style.display = 'none';
    metricChartContainer.style.display = 'block';
    systemChartContainer.classList.remove('active');
    systemBackBtn.style.display = 'block';
    
    const metric = SYSTEM_METRICS.find(m => m.id === metricId);
    if (metric) {
      document.querySelector('.system-panel .panel-title').textContent = metric.name;
      updateMetricChart(metric);
    }
  }
  
  // æ›´æ–°è½¦è¾†åˆ—è¡¨
function updateVehicleList(vehicleList) {
    const tbody = document.querySelector('#vehicle-list tbody');
    tbody.innerHTML = '';
    
    vehicleList.forEach(vehicle => {
        const status = STATUS_MAP[vehicle.status] || { 
            text: vehicle.status, 
            class: 'status-available', 
            icon: 'ğŸš—' 
        };
        
        const row = document.createElement('tr');
        row.dataset.uuid = vehicle.UUID;
        row.innerHTML = `
            <td title="${vehicle.UUID}">${vehicle.UUID.substring(0, 8)}...</td>
            <td><span style="opacity: 0.9;">ğŸšš</span></td>
            <td><span class="vehicle-status ${status.class}">${status.text}</span></td>
            <td><strong>${vehicle.metrics.completeCount || 0}</strong></td>
        `;
        
        row.addEventListener('click', function() {
            showVehicleDetail(vehicle);
        });
        
        tbody.appendChild(row);
    });
}
  
  // æ›´æ–°è½¦è¾†è¯¦æƒ…
  function updateVehicleDetail(vehicle) {
    // æ›´æ–°æ ‡é¢˜å’ŒçŠ¶æ€
    document.getElementById('vehicle-detail-title').innerHTML = `
      <span>è½¦è¾† ${vehicle.UUID}</span>
      <div id="vehicle-status-badge" class="vehicle-status">${STATUS_MAP[vehicle.status]?.icon || 'ğŸš—'} ${STATUS_MAP[vehicle.status]?.text || vehicle.status}</div>
    `;
    
    const status = STATUS_MAP[vehicle.status] || { text: vehicle.status, class: 'status-available' };
    const statusBadge = document.getElementById('vehicle-status-badge');
    statusBadge.textContent = `${status.icon || 'ğŸš—'} ${status.text}`;
    statusBadge.className = `vehicle-status ${status.class}`;
    
    // æ›´æ–°æŒ‡æ ‡ç½‘æ ¼
    const metricsGrid = document.getElementById('vehicle-metrics-grid');
    metricsGrid.innerHTML = '';
    
    VEHICLE_METRICS.forEach(metric => {
      const value = vehicle.metrics[metric.id] || 0;
      const formattedValue = typeof value === 'number' && (metric.id.includes('Distance') || metric.id.includes('Rate') || metric.id === 'utilization') 
        ? value.toFixed(2) 
        : value;
      
      const metricCard = document.createElement('div');
      metricCard.className = 'metric-card';
      metricCard.innerHTML = `
        <h4>${metric.name}</h4>
        <div>
          <span class="value">${formattedValue}</span>
          <span class="unit">${metric.unit}</span>
        </div>
      `;
      
      metricsGrid.appendChild(metricCard);
    });
  }
  
  // æ›´æ–°ç³»ç»ŸæŒ‡æ ‡
  function updateSystemMetrics(vehicleList) {
    // è®¡ç®—ç³»ç»ŸæŒ‡æ ‡
    const totalTransportCount = vehicleList.reduce((sum, v) => sum + (v.metrics.completeCount || 0), 0);
    const totalWeight = vehicleList.reduce((sum, v) => sum + (v.metrics.totalWeight || 0), 0);
    const totalEmptyMileage = vehicleList.reduce((sum, v) => sum + (v.metrics.emptyDistance || 0), 0);
    const totalUtilization = vehicleList.reduce((sum, v) => sum + (v.metrics.utilization || 0), 0);
    const avgUtilization = vehicleList.length > 0 ? totalUtilization / vehicleList.length : 0;
    
    // æ€»ä»£ä»·ä»å†å²æ•°æ®è·å–æœ€æ–°å€¼
    const totalCost = systemMetricsHistory.totalCost.length > 0 
      ? systemMetricsHistory.totalCost[systemMetricsHistory.totalCost.length - 1] 
      : 0;
    
    // æ›´æ–°æŒ‡æ ‡å†å²
    systemMetricsHistory.totalTransportCount.push(totalTransportCount);
    systemMetricsHistory.totalWeight.push(totalWeight);
    systemMetricsHistory.totalEmptyMileage.push(totalEmptyMileage);
    systemMetricsHistory.avgUtilization.push(avgUtilization);
    
    // é™åˆ¶å†å²æ•°æ®é•¿åº¦
    const maxHistoryLength = 20;
    Object.keys(systemMetricsHistory).forEach(key => {
      if (systemMetricsHistory[key].length > maxHistoryLength) {
        systemMetricsHistory[key] = systemMetricsHistory[key].slice(-maxHistoryLength);
      }
    });
    
    // æ›´æ–°æŒ‡æ ‡ç½‘æ ¼
    const metricsGrid = document.getElementById('system-metrics-grid');
    metricsGrid.innerHTML = '';
    
    const metricsData = [
      { id: 'totalCost', value: totalCost },
      { id: 'totalTransportCount', value: totalTransportCount },
      { id: 'totalWeight', value: totalWeight },
      { id: 'totalEmptyMileage', value: totalEmptyMileage },
      { id: 'avgUtilization', value: avgUtilization }
    ];
    
    metricsData.forEach(data => {
      const metric = SYSTEM_METRICS.find(m => m.id === data.id);
      if (!metric) return;
      
      const formattedValue = typeof data.value === 'number' && 
        (metric.id.includes('Mileage') || metric.id === 'avgUtilization' || metric.id === 'totalCost')
        ? data.value.toFixed(2)
        : data.value;
      
      const metricCard = document.createElement('div');
      metricCard.className = 'system-metric-card';
      metricCard.dataset.metricId = metric.id;
      metricCard.style.borderLeft = `3px solid ${metric.borderColor}`;
      metricCard.innerHTML = `
        <h4>${metric.name}</h4>
        <div>
          <span class="value">${formattedValue}</span>
          <span class="unit">${metric.unit}</span>
        </div>
      `;
      
      metricCard.addEventListener('click', function() {
        currentMetricId = metric.id;
        showMetricChart(metric.id);
      });
      
      metricsGrid.appendChild(metricCard);
    });
  }
  
  // åˆå§‹åŒ–å›¾è¡¨ - ä¿®æ”¹åæ ‡è½´ä¸ºè‡ªé€‚åº”
  function initCharts() {
    // ç³»ç»Ÿæ€»ä»£ä»·å›¾è¡¨ - ä¿®æ”¹ä¸ºè‡ªé€‚åº”åæ ‡è½´
    const systemChartCtx = document.getElementById('system-chart').getContext('2d');
    // ç¡®ä¿å›¾è¡¨å®¹å™¨é€‚åº”æ–°çš„é«˜åº¦
    document.getElementById('system-chart-container').style.height = '240px';
    systemChart = new Chart(systemChartCtx, {
      type: currentChartType,
      data: {
        labels: [],
        datasets: [{
          label: 'ç³»ç»Ÿæ€»ä»£ä»·',
          data: [],
          backgroundColor: 'rgba(155, 89, 182, 0.7)',
          borderColor: '#9b59b6',
          borderWidth: 2,
          borderRadius: 6,
          barThickness: 24,
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#9b59b6',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'top',
            labels: {
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 13, weight: '600' },
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(25, 25, 35, 0.95)',
            titleColor: 'rgba(255, 255, 255, 0.9)',
            bodyColor: 'rgba(255, 255, 255, 0.8)',
            borderColor: 'rgba(155, 89, 182, 0.5)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            displayColors: false
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            // ç§»é™¤å›ºå®šä¸Šé™ï¼Œè®©åæ ‡è½´è‡ªé€‚åº”æ•°æ®
            suggestedMin: 0, // å»ºè®®æœ€å°å€¼ä»0å¼€å§‹
            suggestedMax: undefined, // ä¸è®¾ç½®å»ºè®®æœ€å¤§å€¼
            grid: {
              color: 'rgba(255, 255, 255, 0.1)',
              drawBorder: false
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: { size: 12 },
              // è‡ªåŠ¨è°ƒæ•´åˆ»åº¦
              autoSkip: true,
              maxTicksLimit: 10
            },
            title: { 
              display: true, 
              text: 'cost',
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 14, weight: '600' }
            },
            // æ·»åŠ è‡ªé€‚åº”é€‰é¡¹
            afterDataLimits: (scale) => {
              // ç¡®ä¿yè½´æœ‰é€‚å½“çš„è¾¹è·
              const range = scale.max - scale.min;
              scale.min = Math.max(0, scale.min - range * 0.05);
              scale.max = scale.max + range * 0.05;
            }
          },
          x: { 
            grid: {
              color: 'rgba(255, 255, 255, 0.05)',
              drawBorder: false
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: { size: 12 },
              maxRotation: 45,
              minRotation: 0
            },
            title: { 
              display: true, 
              text: 'å‘¨æœŸ',
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 14, weight: '600' }
            } 
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
    
    // å•ä¸ªæŒ‡æ ‡å›¾è¡¨ - ä¿®æ”¹ä¸ºè‡ªé€‚åº”åæ ‡è½´
    const metricChartCtx = document.getElementById('metric-chart').getContext('2d');
    metricChart = new Chart(metricChartCtx, {
      type: currentMetricChartType,
      data: {
        labels: [],
        datasets: [{
          label: '',
          data: [],
          backgroundColor: 'rgba(52, 152, 219, 0.7)',
          borderColor: '#2980b9',
          borderWidth: 2,
          borderRadius: 6,
          barThickness: 24,
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#2980b9',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'top',
            labels: {
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 13, weight: '600' },
              padding: 15
            }
          },
          tooltip: {
            backgroundColor: 'rgba(25, 25, 35, 0.95)',
            titleColor: 'rgba(255, 255, 255, 0.9)',
            bodyColor: 'rgba(255, 255, 255, 0.8)',
            borderColor: 'rgba(52, 152, 219, 0.5)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            displayColors: false
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            // ç§»é™¤å›ºå®šä¸Šé™ï¼Œè®©åæ ‡è½´è‡ªé€‚åº”æ•°æ®
            suggestedMin: 0,
            suggestedMax: undefined,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)',
              drawBorder: false
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: { size: 12 },
              autoSkip: true,
              maxTicksLimit: 10
            },
            title: { 
              display: true, 
              text: 'å€¼',
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 14, weight: '600' }
            },
            // æ·»åŠ è‡ªé€‚åº”é€‰é¡¹
            afterDataLimits: (scale) => {
              const range = scale.max - scale.min;
              scale.min = Math.max(0, scale.min - range * 0.05);
              scale.max = scale.max + range * 0.05;
            }
          },
          x: { 
            grid: {
              color: 'rgba(255, 255, 255, 0.05)',
              drawBorder: false
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: { size: 12 },
              maxRotation: 45,
              minRotation: 0
            },
            title: { 
              display: true, 
              text: 'å‘¨æœŸ',
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 14, weight: '600' }
            } 
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
    
    // æ•£ç‚¹å›¾ - ä¿®æ”¹ä¸ºè‡ªé€‚åº”åæ ‡è½´
    const scatterCtx = document.getElementById('scatter-chart').getContext('2d');
    scatterChart = new Chart(scatterCtx, {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'è½¦è¾†',
          data: [],
          backgroundColor: 'rgba(241, 196, 15, 0.7)',
          borderColor: '#f1c40f',
          borderWidth: 1,
          pointRadius: 6,
          pointHoverRadius: 10,
          pointBackgroundColor: 'rgba(241, 196, 15, 0.8)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(25, 25, 35, 0.95)',
            titleColor: 'rgba(255, 255, 255, 0.9)',
            bodyColor: 'rgba(255, 255, 255, 0.8)',
            borderColor: 'rgba(241, 196, 15, 0.5)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            callbacks: {
              label: function(context) {
                const point = context.raw;
                return [
                  `è½¦è¾†: ${point.vehicleId.substring(0, 8)}...`,
                  `X: ${point.x.toFixed(2)}`,
                  `Y: ${point.y.toFixed(2)}`
                ];
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            // ç§»é™¤å›ºå®šä¸Šé™ï¼Œè®©åæ ‡è½´è‡ªé€‚åº”æ•°æ®
            suggestedMin: 0,
            suggestedMax: undefined,
            grid: {
              color: 'rgba(255, 255, 255, 0.1)',
              drawBorder: false
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: { size: 12 },
              autoSkip: true,
              maxTicksLimit: 10
            },
            title: {
              display: true,
              text: 'Yè½´',
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 14, weight: '600' }
            },
            // æ·»åŠ è‡ªé€‚åº”é€‰é¡¹
            afterDataLimits: (scale) => {
              const range = scale.max - scale.min;
              scale.min = Math.max(0, scale.min - range * 0.05);
              scale.max = scale.max + range * 0.05;
            }
          },
          x: {
            beginAtZero: true,
            // ç§»é™¤å›ºå®šä¸Šé™ï¼Œè®©åæ ‡è½´è‡ªé€‚åº”æ•°æ®
            suggestedMin: 0,
            suggestedMax: undefined,
            grid: {
              color: 'rgba(255, 255, 255, 0.05)',
              drawBorder: false
            },
            ticks: {
              color: 'rgba(255, 255, 255, 0.7)',
              font: { size: 12 },
              autoSkip: true,
              maxTicksLimit: 10
            },
            title: {
              display: true,
              text: 'Xè½´',
              color: 'rgba(255, 255, 255, 0.9)',
              font: { size: 14, weight: '600' }
            },
            // æ·»åŠ è‡ªé€‚åº”é€‰é¡¹
            afterDataLimits: (scale) => {
              const range = scale.max - scale.min;
              scale.min = Math.max(0, scale.min - range * 0.05);
              scale.max = scale.max + range * 0.05;
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'nearest'
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        }
      }
    });
    
    // å›¾è¡¨ç±»å‹åˆ‡æ¢
    document.getElementById('toggle-chart-type').addEventListener('click', function() {
      toggleChartType(systemChart, 'system');
      this.textContent = systemChart.config.type === 'bar' ? 'åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾' : 'åˆ‡æ¢ä¸ºæŸ±çŠ¶å›¾';
    });
    
    document.getElementById('toggle-metric-chart-type').addEventListener('click', function() {
      toggleChartType(metricChart, 'metric');
      this.textContent = metricChart.config.type === 'bar' ? 'åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾' : 'åˆ‡æ¢ä¸ºæŸ±çŠ¶å›¾';
    });
  }
  
  // åˆ‡æ¢å›¾è¡¨ç±»å‹
  function toggleChartType(chartInstance, chartType) {
    const newType = chartInstance.config.type === 'bar' ? 'line' : 'bar';
    chartInstance.config.type = newType;
    
    if (chartType === 'system') {
      currentChartType = newType;
    } else {
      currentMetricChartType = newType;
    }
    
    chartInstance.update();
  }
  
  // æ›´æ–°ç³»ç»Ÿæ€»ä»£ä»·å›¾è¡¨
  function updateSystemChart() {
    // æ›´æ–°æ ‡ç­¾
    const labels = [];
    for (let i = 0; i < systemMetricsHistory.totalCost.length; i++) {
      labels.push(`å‘¨æœŸ${i + 1}`);
    }
    
    systemChart.data.labels = labels;
    systemChart.data.datasets[0].data = systemMetricsHistory.totalCost;
    
    // å¼ºåˆ¶é‡æ–°è®¡ç®—åæ ‡è½´èŒƒå›´
    systemChart.options.scales.y.suggestedMax = undefined;
    systemChart.update();
  }
  
  // æ›´æ–°å•ä¸ªæŒ‡æ ‡å›¾è¡¨
  function updateMetricChart(metric) {
    const metricId = metric.id;
    const historyData = systemMetricsHistory[metricId] || [];
    
    // æ›´æ–°æ ‡ç­¾
    const labels = [];
    for (let i = 0; i < historyData.length; i++) {
      labels.push(`å‘¨æœŸ${i + 1}`);
    }
    
    // æ›´æ–°å›¾è¡¨
    metricChart.data.labels = labels;
    metricChart.data.datasets[0].data = historyData;
    metricChart.data.datasets[0].label = metric.name;
    metricChart.data.datasets[0].backgroundColor = metric.color;
    metricChart.data.datasets[0].borderColor = metric.borderColor;
    
    // å¼ºåˆ¶é‡æ–°è®¡ç®—åæ ‡è½´èŒƒå›´
    metricChart.options.scales.y.suggestedMax = undefined;
    
    document.getElementById('metric-chart-title').textContent = `${metric.name}å˜åŒ–è¶‹åŠ¿`;
    metricChart.update();
  }
  
  // æ›´æ–°æ•£ç‚¹å›¾
  function updateScatterChart() {
    if (!scatterChart || !vehicles.length) return;
    
    const metric = SCATTER_METRICS[currentScatterMetric];
    const currentPeriod = systemMetricsHistory.totalCost.length;
    
    const data = vehicles.map(vehicle => {
      const point = metric.calculate(vehicle, currentPeriod);
      return {
        ...point,
        vehicleId: vehicle.UUID
      };
    });
    
    scatterChart.data.datasets[0].data = data;
    
    // æ›´æ–°åæ ‡è½´æ ‡ç­¾
    scatterChart.options.scales.x.title.text = metric.xLabel;
    scatterChart.options.scales.y.title.text = metric.yLabel;
    
    // å¼ºåˆ¶é‡æ–°è®¡ç®—åæ ‡è½´èŒƒå›´
    scatterChart.options.scales.x.suggestedMax = undefined;
    scatterChart.options.scales.y.suggestedMax = undefined;
    
    scatterChart.update();
  }
  
  // æ˜¾ç¤ºæ•°æ®æ›´æ–°æç¤º
  function showUpdateNotification() {
    updateNotification.classList.add('show');
    setTimeout(() => {
      updateNotification.classList.remove('show');
    }, 2000);
  }
  
  // è·å–ä»ªè¡¨ç›˜æ•°æ®
  async function fetchDashboardData() {
    try {
      let url = new URL('/data/getDashboardData', window.location.origin);
      const res = await fetch(url);
      const responseData = await res.json();
      
      // è§£æåç«¯è¿”å›çš„æ•°æ®ç»“æ„
      let totalCost = 0;
      let carMetrics = [];
      
      // è§£ææ•°æ®ç»“æ„
      for (const [cycleCost, data] of Object.entries(responseData)) {
        totalCost = parseFloat(cycleCost);
        carMetrics = data;
      }
      
      // æ›´æ–°æ€»ä»£ä»·å†å²
      systemMetricsHistory.totalCost.push(totalCost);
      
      // é™åˆ¶å†å²æ•°æ®é•¿åº¦
      const maxHistoryLength = 20;
      if (systemMetricsHistory.totalCost.length > maxHistoryLength) {
        systemMetricsHistory.totalCost = systemMetricsHistory.totalCost.slice(-maxHistoryLength);
      }
      
      // å¤„ç†è½¦è¾†æ•°æ®
      vehicles = carMetrics.map(c => {
        const completeCount = parseInt(c.completeCount) || 0;
        const totalDistance = parseFloat(c.totalDistance) || 0;
        const emptyDistance = parseFloat(c.emptyDistance) || 0;
        const busyTime = parseInt(c.busyTime) || 0;
        const idleTime = parseInt(c.idleTime) || 0;
        
        // è®¡ç®—æ´¾ç”ŸæŒ‡æ ‡
        const idleRate = (busyTime + idleTime) > 0 ? (idleTime / (busyTime + idleTime)) * 100 : 0;
        const utilization = totalDistance > 0 ? ((totalDistance - emptyDistance) / totalDistance) * 100 : 0;
        return {
          UUID: c.UUID,
          status: c.status || "AVAILABLE",
          lat: parseFloat(c.lat) || (30.6 + Math.random() * 0.1),
          lon: parseFloat(c.lon) || (104.0 + Math.random() * 0.1),
          metrics: {
            completeCount: completeCount,
            totalDistance: totalDistance,
            emptyDistance: emptyDistance,
            busyTime: busyTime,
            idleTime: idleTime,
            totalWeight: parseInt(c.totalWeight) || 0,
            accWastedLoad: parseInt(c.accWastedLoad) || 0,
            cost: parseFloat(c.cost) || 0,
            totalCost: parseFloat(c.totalCost) || 0,
            idleRate: idleRate,
            utilization: utilization
          }
        };
      });
      
      // æ›´æ–°UI
      updateVehicleList(vehicles);
      updateSystemMetrics(vehicles);
      updateSystemChart();
      updateScatterChart();
      
      // å¦‚æœå½“å‰æ­£åœ¨æŸ¥çœ‹æŸä¸ªæŒ‡æ ‡çš„å›¾è¡¨ï¼Œæ›´æ–°å®ƒ
      if (metricChartContainer.style.display === 'block') {
        const metric = SYSTEM_METRICS.find(m => m.id === currentMetricId);
        if (metric) {
          updateMetricChart(metric);
        }
      }
      
      // æ˜¾ç¤ºæ›´æ–°æç¤º
      showUpdateNotification();
      
    } catch (err) {
      console.error('è·å–ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', err);
    }
  }
</script>
</body>
</html>
