<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ™ºèƒ½è¿è¾“ç³»ç»Ÿåœ°å›¾</title>
  <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="style.css"/>
  <style></style>
</head>
<body>
  <!-- åœ°å›¾å®¹å™¨ -->
  <div id="container"></div>
  
  <!-- æ•°æ®æ›´æ–°æç¤º -->
  <div id="update-notification" class="update-notification">æ•°æ®å·²æ›´æ–°</div>
  
  <!-- æ§åˆ¶æŒ‰é’® - å·¦ä¸Š -->
  <div class="control-buttons">
    <button id="toggle-vehicle-panel" class="control-btn vehicle-btn">
      <span>ğŸšš è½¦è¾†åˆ—è¡¨åŠæŒ‡æ ‡</span>
      <span class="arrow">â–¼</span>
    </button>
    
    <button id="toggle-system-panel" class="control-btn system-btn">
      <span>ğŸ“Š ç³»ç»ŸæŒ‡æ ‡</span>
      <span class="arrow">â–¼</span>
    </button>
  </div>
  
  <!-- è½¦è¾†æŒ‡æ ‡æ•£ç‚¹å›¾æ¨¡å— - å³ä¸Š -->
  <div class="scatter-control">
    <button id="toggle-scatter-panel" class="scatter-btn">
      <span>ğŸ“ˆ è½¦è¾†æŒ‡æ ‡æ•£ç‚¹å›¾</span>
      <span class="arrow">â–¼</span>
    </button>
  </div>
  
  <!-- æœåŠ¡è´¨é‡æŒ‡æ ‡æ¨¡å— - å³ä¸Šï¼ˆåœ¨æ•£ç‚¹å›¾ä¸‹æ–¹ï¼‰ -->
  <div class="service-quality-control">
    <button id="toggle-service-quality-panel" class="service-quality-btn">
      <span>â­ æœåŠ¡è´¨é‡æŒ‡æ ‡</span>
      <span class="arrow">â–¼</span>
    </button>
  </div>
  
  <!-- è½¦è¾†é¢æ¿ -->
  <div id="vehicle-panel" class="floating-panel vehicle-panel">
    <div class="panel-header">
      <button class="back-btn" id="vehicle-back-btn" title="è¿”å›åˆ—è¡¨">â†</button>
      <h3 class="panel-title">è½¦è¾†åˆ—è¡¨</h3>
      <button class="close-btn" id="close-vehicle-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <!-- è½¦è¾†åˆ—è¡¨è§†å›¾ -->
      <div id="vehicle-list-container" class="vehicle-list-container">
        <table class="vehicle-list-table" id="vehicle-list">
          <thead>
            <tr>
              <th>è½¦è¾†ID</th>
              <th>ç±»å‹</th>
              <th>çŠ¶æ€</th>
              <th>è¿è¾“æ¬¡æ•°</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <!-- è½¦è¾†è¯¦æƒ…è§†å›¾ -->
      <div id="vehicle-detail-container" class="vehicle-detail-container">
        <div class="vehicle-detail-header">
          <h3 id="vehicle-detail-title" class="vehicle-detail-title">
            <span>è½¦è¾†è¯¦æƒ…</span>
            <div id="vehicle-status-badge" class="vehicle-status">çŠ¶æ€</div>
          </h3>
        </div>
        
        <div class="vehicle-metrics-grid" id="vehicle-metrics-grid">
          <!-- æŒ‡æ ‡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- è½¦è¾†æŒ‡æ ‡æŠ˜çº¿å›¾å®¹å™¨ -->
        <div id="vehicle-metric-chart-container" class="chart-container" style="display: none; height: 200px;">
          <div class="chart-header">
            <h3 id="vehicle-metric-chart-title" class="chart-title">è½¦è¾†æŒ‡æ ‡è¶‹åŠ¿</h3>
            <div class="chart-actions">
              <button id="close-vehicle-chart" class="chart-btn">è¿”å›</button>
            </div>
          </div>
          <canvas id="vehicle-metric-chart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ç³»ç»ŸæŒ‡æ ‡é¢æ¿ -->
  <div id="system-panel" class="floating-panel system-panel">
    <div class="panel-header">
      <button class="back-btn" id="system-back-btn" title="è¿”å›æŒ‡æ ‡">â†</button>
      <h3 class="panel-title">ç³»ç»ŸæŒ‡æ ‡</h3>
      <button class="close-btn" id="close-system-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <!-- ç³»ç»ŸæŒ‡æ ‡è§†å›¾ -->
      <div id="system-metrics-container" class="system-metrics-container">
        <div class="system-metrics-grid" id="system-metrics-grid">
          <!-- ç³»ç»ŸæŒ‡æ ‡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡å›¾è¡¨å®¹å™¨ -->
        <div class="chart-container" id="system-chart-container">
          <div class="chart-header">
            <h3 id="chart-title" class="chart-title">ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡è¶‹åŠ¿</h3>
            <div class="chart-actions">
              <button id="toggle-chart-type" class="chart-btn">åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾</button>
            </div>
          </div>
          <canvas id="system-chart"></canvas>
        </div>
      </div>
      
      <!-- å•ä¸ªæŒ‡æ ‡å›¾è¡¨è§†å›¾ -->
      <div id="metric-chart-container" class="chart-container" style="display: none; height: 200px;">
        <div class="chart-header">
          <h3 id="metric-chart-title" class="chart-title">æŒ‡æ ‡è¯¦æƒ…</h3>
          <div class="chart-actions">
            <button id="close-metric-chart" class="chart-btn">è¿”å›</button>
          </div>
        </div>
        <canvas id="metric-chart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- æ•£ç‚¹å›¾é¢æ¿ -->
  <div id="scatter-panel" class="floating-panel scatter-panel">
    <div class="panel-header">
      <h3 class="panel-title">è½¦è¾†æŒ‡æ ‡æ•£ç‚¹å›¾</h3>
      <button class="close-btn" id="close-scatter-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <div class="scatter-metrics-container">
        <button class="scatter-metric-btn active" data-metric="mileage_utilization_rate">é‡Œç¨‹åˆ©ç”¨ç‡æ•£ç‚¹å›¾</button>
        <button class="scatter-metric-btn" data-metric="effectiveTimeRatio">æœ‰æ•ˆè¿æ—¶æ¯”æ•£ç‚¹å›¾</button>
        <button class="scatter-metric-btn" data-metric="load_utilization_rate">å®æ—¶è£…è½½ç‡æ•£ç‚¹å›¾</button>
        <button class="scatter-metric-btn" data-metric="carbon_emission_per_unit">å•ä½è¿é‡ç¢³æ’æ”¾æ•£ç‚¹å›¾</button>
        <button class="scatter-metric-btn" data-metric="capacity_utilization_rate">è¿åŠ›åˆ©ç”¨ç‡æ•£ç‚¹å›¾</button>
      </div>
      
      <div class="chart-container" id="scatter-chart-container" style="display: block; height: 350px;">
        <div class="chart-header">
          <h3 id="scatter-chart-title" class="chart-title">é‡Œç¨‹åˆ©ç”¨ç‡æ•£ç‚¹å›¾</h3>
          <div class="chart-actions">
            <button id="reset-scatter-zoom" class="chart-btn">é‡ç½®è§†å›¾</button>
          </div>
        </div>
        <canvas id="scatter-chart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- æœåŠ¡è´¨é‡æŒ‡æ ‡é¢æ¿ -->
  <div id="service-quality-panel" class="floating-panel service-quality-panel">
    <div class="panel-header">
      <button class="back-btn" id="service-quality-back-btn" title="è¿”å›æŒ‡æ ‡" style="display: none;">â†</button>
      <h3 class="panel-title">æœåŠ¡è´¨é‡æŒ‡æ ‡</h3>
      <button class="close-btn" id="close-service-quality-panel" title="å…³é—­">Ã—</button>
    </div>
    
    <div class="panel-content">
      <!-- æœåŠ¡è´¨é‡æŒ‡æ ‡è§†å›¾ -->
      <div id="service-quality-metrics-container" style="display: block;">
        <div class="system-metrics-grid" id="service-quality-metrics-grid">
          <!-- æœåŠ¡è´¨é‡æŒ‡æ ‡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- æœåŠ¡è´¨é‡æŒ‡æ ‡å›¾è¡¨å®¹å™¨ -->
        <div class="chart-container" id="service-quality-chart-container">
          <div class="chart-header">
            <h3 id="service-quality-chart-title" class="chart-title">æœåŠ¡è´¨é‡æŒ‡æ ‡è¶‹åŠ¿</h3>
            <div class="chart-actions">
              <button id="toggle-service-quality-chart-type" class="chart-btn">åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾</button>
          </div>
        </div>
        <canvas id="service-quality-chart"></canvas>
      </div>
      
      <!-- å•ä¸ªæœåŠ¡è´¨é‡æŒ‡æ ‡å›¾è¡¨è§†å›¾ -->
      <div id="service-quality-metric-chart-container" class="chart-container" style="display: none; height: 200px;">
        <div class="chart-header">
          <h3 id="service-quality-metric-chart-title" class="chart-title">æœåŠ¡è´¨é‡æŒ‡æ ‡è¯¦æƒ…</h3>
          <div class="chart-actions">
            <button id="close-service-quality-metric-chart" class="chart-btn">è¿”å›</button>
          </div>
        </div>
        <canvas id="service-quality-metric-chart"></canvas>
      </div>
    </div>
  </div>
  
  <!-- åº•éƒ¨æŒ‰é’® -->
  <div class="bottom-buttons">
    <button id="open-comparison" class="bottom-btn comparison-btn">
      <span>ğŸ“Š</span>
      <span>æ‰“å¼€å¯¹æ¯”å›¾</span>
    </button>
  </div>
  
  <!-- æ¨¡æ€æ¡† -->
  <div id="vehicle-modal">
    <h3 id="modal-title">è½¦è¾†è¯¦æƒ…</h3>
    <div id="modal-body"></div>
    <div style="text-align: right; margin-top: 20px;">
      <button onclick="document.getElementById('vehicle-modal').style.display='none'">
        å…³é—­
      </button>
    </div>
  </div>

  <script type="text/javascript">
    window._AMapSecurityConfig = {
      securityJsCode:"9858defc87670662758db011c95df7ac"
    };
  </script>
  
  <script type="module">
    // map.htmlä¸­çš„JavaScriptéƒ¨åˆ†æ›´æ–°
    // å…¨å±€å˜é‡
    let map;
    let vehicles = [];
    let currentPeriod = 1;
    
    // è½¦è¾†æŒ‡æ ‡å®šä¹‰ï¼ˆæ ¹æ®getDashboardDataæ¥å£ï¼‰
    const VEHICLE_METRICS = [
      { id: 'waitingTime', name: 'ç­‰å¾…æ—¶é—´', unit: 'å°æ—¶', color: 'rgba(52, 152, 219, 0.8)', borderColor: '#3498db' },
      { id: 'emptyDistance', name: 'ç©ºè½½é‡Œç¨‹', unit: 'åƒç±³', color: 'rgba(155, 89, 182, 0.8)', borderColor: '#9b59b6' },
      { id: 'wastedLoad', name: 'è½½é‡æµªè´¹', unit: 'å¨', color: 'rgba(231, 76, 60, 0.8)', borderColor: '#e74c3c' },
      { id: 'totalWeight', name: 'æ€»è¿é‡', unit: 'å¨', color: 'rgba(46, 204, 113, 0.8)', borderColor: '#2ecc71' },
      { id: 'carbonEmission', name: 'ç¢³æ’æ”¾é‡', unit: 'å¨', color: 'rgba(39, 174, 96, 0.8)', borderColor: '#27ae60' },
      { id: 'totalDistance', name: 'æ€»è¡Œé©¶é‡Œç¨‹', unit: 'åƒç±³', color: 'rgba(243, 156, 18, 0.8)', borderColor: '#f39c12' },
      { id: 'completedOrders', name: 'è¿è¾“æ¬¡æ•°', unit: 'æ¬¡', color: 'rgba(241, 196, 15, 0.8)', borderColor: '#f1c40f' },
      { id: 'completeOrderCycle', name: 'å®Œæˆè®¢å•å‘¨æœŸæ•°', unit: 'å‘¨æœŸ', color: 'rgba(22, 160, 133, 0.8)', borderColor: '#16a085' },
      { id: 'averageOrderCycle', name: 'å¹³å‡è®¢å•å‘¨æœŸæ•°', unit: 'å‘¨æœŸ', color: 'rgba(230, 126, 34, 0.8)', borderColor: '#e67e22' },
      { id: 'mileage_utilization_rate', name: 'é‡Œç¨‹åˆ©ç”¨ç‡', unit: '', color: 'rgba(41, 128, 185, 0.8)', borderColor: '#2980b9' },
      { id: 'carbon_emission_per_unit', name: 'å•ä½è¿é‡ç¢³æ’æ”¾', unit: 'å¨/å¨', color: 'rgba(142, 68, 173, 0.8)', borderColor: '#8e44ad' },
      { id: 'load_utilization_rate', name: 'å®æ—¶è£…è½½ç‡', unit: '', color: 'rgba(192, 57, 43, 0.8)', borderColor: '#c0392b' },
      { id: 'capacity_utilization_rate', name: 'è¿åŠ›åˆ©ç”¨ç‡', unit: '', color: 'rgba(211, 84, 0, 0.8)', borderColor: '#d35400' }
    ];

    // è½¦è¾†ç»Ÿè®¡æŒ‡æ ‡å®šä¹‰ï¼ˆæ¥è‡ªgetAllCarsStatisticsæ¥å£ï¼‰
    const CAR_STATISTICS_METRICS = [
      { id: 'loadUtilizationRateMean', name: 'å¹³å‡è£…è½½ç‡', unit: '', color: 'rgba(46, 204, 113, 0.8)', borderColor: '#2ecc71' },
      { id: 'loadUtilizationRateVariance', name: 'è£…è½½ç‡æ–¹å·®', unit: '', color: 'rgba(52, 152, 219, 0.8)', borderColor: '#3498db' },
      { id: 'capacityUtilizationRateMean', name: 'å¹³å‡è¿åŠ›åˆ©ç”¨ç‡', unit: '', color: 'rgba(241, 196, 15, 0.8)', borderColor: '#f1c40f' },
      { id: 'capacityUtilizationRateVariance', name: 'è¿åŠ›åˆ©ç”¨ç‡æ–¹å·®', unit: '', color: 'rgba(231, 76, 60, 0.8)', borderColor: '#e74c3c' },
      { id: 'availableCount', name: 'å¯ç”¨è½¦è¾†æ•°', unit: 'è¾†', color: 'rgba(39, 174, 96, 0.8)', borderColor: '#27ae60' },
      { id: 'malfunctionCount', name: 'æ•…éšœè½¦è¾†æ•°', unit: 'è¾†', color: 'rgba(192, 57, 43, 0.8)', borderColor: '#c0392b' }
    ];

    // æœåŠ¡è´¨é‡æŒ‡æ ‡å®šä¹‰ï¼ˆæ¥è‡ªgetServiceQualityMetricsæ¥å£ï¼‰
    const SERVICE_QUALITY_METRICS = [
      { id: 'ontimeDeliveryRate', name: 'å‡†æ—¶äº¤ä»˜ç‡', unit: '', color: 'rgba(46, 204, 113, 0.8)', borderColor: '#2ecc71' },
      { id: 'totalDelayTime', name: 'æ€»å»¶è¿Ÿæ—¶é—´', unit: 'å°æ—¶', color: 'rgba(231, 76, 60, 0.8)', borderColor: '#e74c3c' },
      { id: 'averageDelayTime', name: 'å¹³å‡å»¶è¿Ÿæ—¶é—´', unit: 'å°æ—¶', color: 'rgba(243, 156, 18, 0.8)', borderColor: '#f39c12' },
      { id: 'averageOrderCycle', name: 'å¹³å‡è®¢å•å‘¨æœŸ', unit: 'å‘¨æœŸ', color: 'rgba(155, 89, 182, 0.8)', borderColor: '#9b59b6' }
    ];

    // ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡å®šä¹‰ï¼ˆæ¥è‡ªgetSystemMetricsæ¥å£ï¼‰
    const SYSTEM_METRICS = [
      { id: 'systemCriticalLoad', name: 'ç³»ç»Ÿä¸´ç•Œè´Ÿè½½', unit: '', color: 'rgba(155, 89, 182, 0.8)', borderColor: '#9b59b6' }
    ];

    // æ•£ç‚¹å›¾æŒ‡æ ‡å®šä¹‰
    const SCATTER_METRICS = {
      'mileage_utilization_rate': { 
        name: 'é‡Œç¨‹åˆ©ç”¨ç‡æ•£ç‚¹å›¾', 
        xAxis: 'totalDistance', 
        yAxis: 'mileage_utilization_rate',
        xLabel: 'æ€»è¡Œé©¶é‡Œç¨‹(åƒç±³)',
        yLabel: 'é‡Œç¨‹åˆ©ç”¨ç‡'
      },
      'effectiveTimeRatio': { 
        name: 'æœ‰æ•ˆè¿æ—¶æ¯”æ•£ç‚¹å›¾', 
        xAxis: 'completeOrderCycle', 
        yAxis: 'effectiveTimeRatio',
        xLabel: 'å®Œæˆè®¢å•å‘¨æœŸæ•°',
        yLabel: 'æœ‰æ•ˆè¿æ—¶æ¯”'
      },
      'load_utilization_rate': { 
        name: 'å®æ—¶è£…è½½ç‡æ•£ç‚¹å›¾', 
        xAxis: 'totalWeight', 
        yAxis: 'load_utilization_rate',
        xLabel: 'æ€»è¿é‡(å¨)',
        yLabel: 'å®æ—¶è£…è½½ç‡'
      },
      'carbon_emission_per_unit': { 
        name: 'å•ä½è¿é‡ç¢³æ’æ”¾æ•£ç‚¹å›¾', 
        xAxis: 'totalWeight', 
        yAxis: 'carbon_emission_per_unit',
        xLabel: 'æ€»è¿é‡(å¨)',
        yLabel: 'å•ä½è¿é‡ç¢³æ’æ”¾(å¨/å¨)'
      },
      'capacity_utilization_rate': { 
        name: 'è¿åŠ›åˆ©ç”¨ç‡æ•£ç‚¹å›¾', 
        xAxis: 'carbonEmission', 
        yAxis: 'capacity_utilization_rate',
        xLabel: 'ç¢³æ’æ”¾é‡(å¨)',
        yLabel: 'è¿åŠ›åˆ©ç”¨ç‡'
      }
    };
    
    // çŠ¶æ€æ˜ å°„
    const STATUS_MAP = {
      "AVAILABLE": { text: 'ç©ºé—²', class: 'status-available', icon: 'ğŸŸ¢' },
      "ORDER_TAKEN": { text: 'æ¥å•è¡Œé©¶', class: 'status-order-taken', icon: 'ğŸ›£ï¸' },
      "TRANSPORTING": { text: 'è¿è´§è¡Œé©¶', class: 'status-transporting', icon: 'ğŸšš' },
      "UNLOADING": { text: 'å¸è´§', class: 'status-unloading', icon: 'ğŸ“¦' },
      "LOADING": { text: 'è£…è´§', class: 'status-loading', icon: 'ğŸ“¥' },
      "FREEZE": { text: 'åœè½¦ç­‰å¾…', class: 'status-freeze', icon: 'â¸ï¸' }
    };

    // å›¾è¡¨å®ä¾‹
    let systemChart = null;
    let metricChart = null;
    let scatterChart = null;
    let serviceQualityChart = null;
    let vehicleMetricChart = null;
    let serviceQualityMetricChart = null;
    let currentChartType = 'bar';
    let currentMetricChartType = 'bar';
    let currentMetricId = 'totalCost';
    let currentScatterMetric = 'mileage_utilization_rate';

    // å†å²æ•°æ®å­˜å‚¨
    let vehicleMetricsHistory = {}; // {vehicleId: {metricId: [å†å²æ•°æ®]}}
    let carStatisticsHistory = {}; // {metricId: [å†å²æ•°æ®]}
    let systemMetricsHistory = {}; // {metricId: [å†å²æ•°æ®]}
    let serviceQualityHistory = {}; // {metricId: [å†å²æ•°æ®]}
    let periodLabels = []; // å‘¨æœŸæ ‡ç­¾

    // DOMå…ƒç´ 
    const toggleVehiclePanelBtn = document.getElementById('toggle-vehicle-panel');
    const toggleSystemPanelBtn = document.getElementById('toggle-system-panel');
    const toggleScatterPanelBtn = document.getElementById('toggle-scatter-panel');
    const toggleServiceQualityPanelBtn = document.getElementById('toggle-service-quality-panel');
    const vehiclePanel = document.getElementById('vehicle-panel');
    const systemPanel = document.getElementById('system-panel');
    const scatterPanel = document.getElementById('scatter-panel');
    const serviceQualityPanel = document.getElementById('service-quality-panel');
    const closeVehiclePanelBtn = document.getElementById('close-vehicle-panel');
    const closeSystemPanelBtn = document.getElementById('close-system-panel');
    const closeScatterPanelBtn = document.getElementById('close-scatter-panel');
    const closeServiceQualityPanelBtn = document.getElementById('close-service-quality-panel');
    const vehicleBackBtn = document.getElementById('vehicle-back-btn');
    const systemBackBtn = document.getElementById('system-back-btn');
    const serviceQualityBackBtn = document.getElementById('service-quality-back-btn');
    const vehicleListContainer = document.getElementById('vehicle-list-container');
    const vehicleDetailContainer = document.getElementById('vehicle-detail-container');
    const systemMetricsContainer = document.getElementById('system-metrics-container');
    const metricChartContainer = document.getElementById('metric-chart-container');
    const systemChartContainer = document.getElementById('system-chart-container');
    const scatterChartContainer = document.getElementById('scatter-chart-container');
    const serviceQualityMetricsGrid = document.getElementById('service-quality-metrics-grid');
    const serviceQualityMetricsContainer = document.getElementById('service-quality-metrics-container');
    const serviceQualityChartContainer = document.getElementById('service-quality-chart-container');
    const serviceQualityMetricChartContainer = document.getElementById('service-quality-metric-chart-container');
    const vehicleMetricChartContainer = document.getElementById('vehicle-metric-chart-container');
    const updateNotification = document.getElementById('update-notification');
    const closeVehicleChartBtn = document.getElementById('close-vehicle-chart');
    const closeMetricChartBtn = document.getElementById('close-metric-chart');
    const closeServiceQualityMetricChartBtn = document.getElementById('close-service-quality-metric-chart');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initUI();
      initCharts();
      initScatterPanel();
      initServiceQualityPanel();
      initHistoryStorage();
      
      // è·å–åˆå§‹æ•°æ®
      fetchAllData();
      
      // è®¾ç½®å®šæ—¶æ›´æ–°
      setInterval(fetchAllData, 5000);
      
      // åˆå§‹åŒ–åœ°å›¾
      if (typeof AMap !== 'undefined') {
        initMap();
      }
    });

    // åˆå§‹åŒ–åœ°å›¾
    function initMap() {
      map = new AMap.Map('container', {
        zoom: 12,
        center: [104.06, 30.67],
        viewMode: '3D',
        pitch: 50,
        rotation: -15,
        mapStyle: 'amap://styles/dark',
        features: ['bg', 'road', 'building'],
        showLabel: true
      });
    }

    // åˆå§‹åŒ–UI
    function initUI() {
      // è½¦è¾†é¢æ¿æ§åˆ¶
      toggleVehiclePanelBtn.addEventListener('click', function() {
        const isActive = this.classList.contains('active');
        
        if (isActive) {
          hideVehiclePanel();
        } else {
          showVehiclePanel();
        }
      });
      
      closeVehiclePanelBtn.addEventListener('click', hideVehiclePanel);
      
      // ç³»ç»Ÿé¢æ¿æ§åˆ¶
      toggleSystemPanelBtn.addEventListener('click', function() {
        const isActive = this.classList.contains('active');
        
        if (isActive) {
          hideSystemPanel();
        } else {
          showSystemPanel();
        }
      });
      
      closeSystemPanelBtn.addEventListener('click', hideSystemPanel);
      
      // è¿”å›æŒ‰é’®
      vehicleBackBtn.addEventListener('click', function() {
        showVehicleList();
      });
      
      systemBackBtn.addEventListener('click', function() {
        showSystemMetrics();
      });
      
      serviceQualityBackBtn.addEventListener('click', function() {
        showServiceQualityMetrics();
      });
      
      // å›¾è¡¨è¿”å›æŒ‰é’®
      if (closeVehicleChartBtn) {
        closeVehicleChartBtn.addEventListener('click', function() {
          hideVehicleMetricChart();
        });
      }
      
      if (closeMetricChartBtn) {
        closeMetricChartBtn.addEventListener('click', function() {
          showSystemMetrics();
        });
      }
      
      if (closeServiceQualityMetricChartBtn) {
        closeServiceQualityMetricChartBtn.addEventListener('click', function() {
          showServiceQualityMetrics();
        });
      }
      
      // å¯¹æ¯”å›¾æŒ‰é’®
      document.getElementById('open-comparison').addEventListener('click', function() {
        window.open('comparison.html', '_blank');
      });
      
      // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­é¢æ¿
      document.getElementById('container').addEventListener('click', function(e) {
        if (!vehiclePanel.contains(e.target) && !systemPanel.contains(e.target) && 
            !scatterPanel.contains(e.target) && !serviceQualityPanel.contains(e.target) && 
            !toggleVehiclePanelBtn.contains(e.target) && !toggleSystemPanelBtn.contains(e.target) && 
            !toggleScatterPanelBtn.contains(e.target) && !toggleServiceQualityPanelBtn.contains(e.target)) {
          hideVehiclePanel();
          hideSystemPanel();
          hideScatterPanel();
          hideServiceQualityPanel();
        }
      });
    }

    // åˆå§‹åŒ–æ•£ç‚¹å›¾é¢æ¿
    function initScatterPanel() {
      // æ•£ç‚¹å›¾é¢æ¿æ§åˆ¶
      toggleScatterPanelBtn.addEventListener('click', function() {
        const isActive = this.classList.contains('active');
        
        if (isActive) {
          hideScatterPanel();
        } else {
          showScatterPanel();
        }
      });
      
      closeScatterPanelBtn.addEventListener('click', hideScatterPanel);
      
      // æŒ‡æ ‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.scatter-metric-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.scatter-metric-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          currentScatterMetric = this.dataset.metric;
          updateScatterChart();
          
          // æ›´æ–°å›¾è¡¨æ ‡é¢˜
          document.getElementById('scatter-chart-title').textContent = 
            SCATTER_METRICS[currentScatterMetric].name;
        });
      });
      
      // é‡ç½®è§†å›¾æŒ‰é’®
      document.getElementById('reset-scatter-zoom').addEventListener('click', function() {
        if (scatterChart) {
          scatterChart.resetZoom();
        }
      });
    }

    // åˆå§‹åŒ–æœåŠ¡è´¨é‡é¢æ¿
    function initServiceQualityPanel() {
      toggleServiceQualityPanelBtn.addEventListener('click', function() {
        const isActive = this.classList.contains('active');
        
        if (isActive) {
          hideServiceQualityPanel();
        } else {
          showServiceQualityPanel();
        }
      });
      
      closeServiceQualityPanelBtn.addEventListener('click', hideServiceQualityPanel);
    }

    // åˆå§‹åŒ–å†å²æ•°æ®å­˜å‚¨
    function initHistoryStorage() {
      // åˆå§‹åŒ–è½¦è¾†ç»Ÿè®¡æŒ‡æ ‡å†å²
      CAR_STATISTICS_METRICS.forEach(metric => {
        carStatisticsHistory[metric.id] = [];
      });
      
      // åˆå§‹åŒ–ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡å†å²
      SYSTEM_METRICS.forEach(metric => {
        systemMetricsHistory[metric.id] = [];
      });
      
      // åˆå§‹åŒ–æœåŠ¡è´¨é‡æŒ‡æ ‡å†å²
      SERVICE_QUALITY_METRICS.forEach(metric => {
        serviceQualityHistory[metric.id] = [];
      });
      
      // åˆå§‹åŒ–ç³»ç»Ÿè®¡ç®—æŒ‡æ ‡å†å²
      const systemCalcMetrics = ['totalCost', 'totalTransportCount', 'totalWeight', 'totalEmptyMileage', 'avgUtilization'];
      systemCalcMetrics.forEach(metric => {
        systemMetricsHistory[metric] = [];
      });
      
      // åˆå§‹åŒ–å‘¨æœŸæ ‡ç­¾
      for (let i = 1; i <= 5; i++) {
        periodLabels.push(`å‘¨æœŸ ${i}`);
      }
    }

    // æ˜¾ç¤º/éšè—é¢æ¿å‡½æ•°
    function showVehiclePanel() {
      vehiclePanel.style.display = 'block';
      toggleVehiclePanelBtn.classList.add('active');
      toggleVehiclePanelBtn.querySelector('.arrow').textContent = 'â–²';
    }

    function hideVehiclePanel() {
      vehiclePanel.style.display = 'none';
      toggleVehiclePanelBtn.classList.remove('active');
      toggleVehiclePanelBtn.querySelector('.arrow').textContent = 'â–¼';
    }

    function showSystemPanel() {
      systemPanel.style.display = 'block';
      toggleSystemPanelBtn.classList.add('active');
      toggleSystemPanelBtn.querySelector('.arrow').textContent = 'â–²';
    }

    function hideSystemPanel() {
      systemPanel.style.display = 'none';
      toggleSystemPanelBtn.classList.remove('active');
      toggleSystemPanelBtn.querySelector('.arrow').textContent = 'â–¼';
    }

    function showScatterPanel() {
      scatterPanel.style.display = 'block';
      toggleScatterPanelBtn.classList.add('active');
      toggleScatterPanelBtn.querySelector('.arrow').textContent = 'â–²';
    }

    function hideScatterPanel() {
      scatterPanel.style.display = 'none';
      toggleScatterPanelBtn.classList.remove('active');
      toggleScatterPanelBtn.querySelector('.arrow').textContent = 'â–¼';
    }

    function showServiceQualityPanel() {
      serviceQualityPanel.style.display = 'block';
      toggleServiceQualityPanelBtn.classList.add('active');
      toggleServiceQualityPanelBtn.querySelector('.arrow').textContent = 'â–²';
    }

    function hideServiceQualityPanel() {
      serviceQualityPanel.style.display = 'none';
      toggleServiceQualityPanelBtn.classList.remove('active');
      toggleServiceQualityPanelBtn.querySelector('.arrow').textContent = 'â–¼';
    }

    // æ˜¾ç¤ºè½¦è¾†åˆ—è¡¨
    function showVehicleList() {
      vehicleListContainer.style.display = 'block';
      vehicleDetailContainer.style.display = 'none';
      vehicleBackBtn.style.display = 'none';
      
      // éšè—è½¦è¾†æŒ‡æ ‡å›¾è¡¨
      hideVehicleMetricChart();
    }

    // æ˜¾ç¤ºç³»ç»ŸæŒ‡æ ‡
    function showSystemMetrics() {
      systemMetricsContainer.style.display = 'block';
      metricChartContainer.style.display = 'none';
      systemBackBtn.style.display = 'none';
    }

    // æ˜¾ç¤ºæœåŠ¡è´¨é‡æŒ‡æ ‡
    function showServiceQualityMetrics() {
      serviceQualityMetricsContainer.style.display = 'block';
      serviceQualityMetricChartContainer.style.display = 'none';
      serviceQualityBackBtn.style.display = 'none';
    }

    // éšè—è½¦è¾†æŒ‡æ ‡å›¾è¡¨
    function hideVehicleMetricChart() {
      vehicleMetricChartContainer.style.display = 'none';
      document.getElementById('vehicle-metrics-grid').style.display = 'grid';
    }

    // è·å–æ‰€æœ‰æ•°æ®
    async function fetchAllData() {
      try {
        currentPeriod++;
        
        // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
        const [vehicleList, carStatistics, serviceQuality, systemMetrics] = await Promise.all([
          fetchVehicleList(),
          fetchCarStatistics(),
          fetchServiceQualityMetrics(),
          fetchSystemMetrics()
        ]);
        
        // æ›´æ–°æŒ‡æ ‡å†å²æ•°æ®
        updateMetricsHistory(carStatistics, carStatisticsHistory, CAR_STATISTICS_METRICS);
        updateMetricsHistory(serviceQuality, serviceQualityHistory, SERVICE_QUALITY_METRICS);
        updateMetricsHistory(systemMetrics, systemMetricsHistory, SYSTEM_METRICS);
        
        // æ›´æ–°UI
        updateVehicleList(vehicleList);
        updateServiceQualityMetrics(serviceQuality);
        updateSystemMetrics(systemMetrics);
        
        // æ˜¾ç¤ºæ›´æ–°æç¤º
        showUpdateNotification();
        
      } catch (err) {
        console.error('è·å–æ•°æ®å¤±è´¥:', err);
      }
    }

    // è·å–è½¦è¾†åˆ—è¡¨
    async function fetchVehicleList() {
      try {
        const response = await fetch('/data/getCarData');
        const vehicleData = await response.json();
        
        // è·å–æ¯ä¸ªè½¦è¾†çš„è¯¦ç»†æ•°æ®
        const vehicles = await Promise.all(vehicleData.map(async (car) => {
          const metrics = await fetchVehicleDashboardData(car.UUID);
          return {
            ...car,
            metrics: metrics
          };
        }));
        
        return vehicles;
      } catch (err) {
        console.error('è·å–è½¦è¾†åˆ—è¡¨å¤±è´¥:', err);
        return [];
      }
    }

    // è·å–å•ä¸ªè½¦è¾†çš„ä»ªè¡¨ç›˜æ•°æ®
    async function fetchVehicleDashboardData(uuid) {
      try {
        const response = await fetch(`/data/getDashboardData?UUID=${uuid}`);
        const data = await response.json();
        
        // è®¡ç®—æœ‰æ•ˆè¿æ—¶æ¯”ï¼ˆè·è½½éé›¶æ—¶é•¿ / éç©ºé—²æ—¶é•¿ï¼‰
        // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æ•°æ®è®¡ç®—ï¼Œå‡è®¾æœ‰è·è½½æ—¶é•¿å­—æ®µï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        const effectiveTimeRatio = data.totalDistance > 0 ? 
          data.totalDistance / (data.totalDistance + (data.waitingTime || 0)) : 0;
        
        // ç¡®ä¿è¿”å›çš„å­—æ®µä¸åç«¯ä¸€è‡´ï¼ˆé©¼å³°å’Œä¸‹åˆ’çº¿æ··åˆï¼‰
        return {
          ...data,
          effectiveTimeRatio
        };
      } catch (err) {
        console.error(`è·å–è½¦è¾†${uuid}æ•°æ®å¤±è´¥:`, err);
        return {};
      }
    }
    
    // è·å–è½¦è¾†ç»Ÿè®¡æŒ‡æ ‡
    async function fetchCarStatistics() {
      try {
        const response = await fetch('/data/getAllCarsStatistics');
        const data = await response.json();
        
        // åç«¯è¿”å›çš„æ˜¯ä¸‹åˆ’çº¿å‘½åï¼Œéœ€è¦è½¬æ¢ä¸ºé©¼å³°å‘½åä»¥åŒ¹é…å‰ç«¯å®šä¹‰
        const transformedData = {
          loadUtilizationRateMean: parseFloat(data.Load_utilization_rate_mean) || 0,
          loadUtilizationRateVariance: parseFloat(data.Load_utilization_rate_variance) || 0,
          capacityUtilizationRateMean: parseFloat(data.Capacity_utilization_rate_mean) || 0,
          capacityUtilizationRateVariance: parseFloat(data.Capacity_utilization_rate_variance) || 0,
          availableCount: parseInt(data.Available_count) || 0,
          malfunctionCount: parseInt(data.Malfunction_count) || 0
        };
        
        return transformedData;
      } catch (err) {
        console.error('è·å–è½¦è¾†ç»Ÿè®¡æŒ‡æ ‡å¤±è´¥:', err);
        return {};
      }
    }

    // è·å–æœåŠ¡è´¨é‡æŒ‡æ ‡
    async function fetchServiceQualityMetrics() {
      try {
        const response = await fetch('/data/getServiceQualityMetrics');
        const data = await response.json();
        
        // åç«¯è¿”å›çš„æ˜¯ä¸‹åˆ’çº¿å‘½åï¼Œéœ€è¦è½¬æ¢ä¸ºé©¼å³°å‘½åä»¥åŒ¹é…å‰ç«¯å®šä¹‰
        const transformedData = {
          ontimeDeliveryRate: parseFloat(data.Ontime_delivery_rate) || 0,
          totalDelayTime: parseFloat(data.Total_delay_time) || 0,
          averageDelayTime: parseFloat(data.Average_delay_time) || 0,
          averageOrderCycle: parseFloat(data.Average_order_cycle) || 0
        };
        
        return transformedData;
      } catch (err) {
        console.error('è·å–æœåŠ¡è´¨é‡æŒ‡æ ‡å¤±è´¥:', err);
        return {};
      }
    }

    // è·å–ç³»ç»ŸæŒ‡æ ‡
    async function fetchSystemMetrics() {
      try {
        const response = await fetch('/data/getSystemMetrics');
        const data = await response.json();
        
        // åç«¯è¿”å›çš„æ˜¯ä¸‹åˆ’çº¿å‘½åï¼Œéœ€è¦è½¬æ¢ä¸ºé©¼å³°å‘½åä»¥åŒ¹é…å‰ç«¯å®šä¹‰
        const transformedData = {
          systemCriticalLoad: parseFloat(data.System_critical_load) || 0
        };
        
        return transformedData;
      } catch (err) {
        console.error('è·å–ç³»ç»ŸæŒ‡æ ‡å¤±è´¥:', err);
        return {};
      }
    }

    // é€šç”¨å†å²æ•°æ®æ›´æ–°å‡½æ•°
    function updateMetricsHistory(currentData, historyStorage, metricsList) {
      metricsList.forEach(metric => {
        const value = currentData[metric.id] || 0;
        if (!historyStorage[metric.id]) {
          historyStorage[metric.id] = [];
        }
        historyStorage[metric.id].push(value);
        
        // ä¿ç•™æœ€è¿‘5ä¸ªå‘¨æœŸ
        if (historyStorage[metric.id].length > 5) {
          historyStorage[metric.id].shift();
        }
      });
    }

    // æ›´æ–°è½¦è¾†åˆ—è¡¨
    function updateVehicleList(vehicleList) {
      const tbody = document.querySelector('#vehicle-list tbody');
      tbody.innerHTML = '';
      
      vehicles = vehicleList;
      
      vehicleList.forEach(vehicle => {
        // åˆå§‹åŒ–è½¦è¾†å†å²æ•°æ®å­˜å‚¨
        if (!vehicleMetricsHistory[vehicle.UUID]) {
          vehicleMetricsHistory[vehicle.UUID] = {};
          VEHICLE_METRICS.forEach(metric => {
            vehicleMetricsHistory[vehicle.UUID][metric.id] = [];
          });
        }
        
        // æ›´æ–°å†å²æ•°æ®ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªå‘¨æœŸï¼‰
        VEHICLE_METRICS.forEach(metric => {
          const value = vehicle.metrics[metric.id];
          if (value !== undefined) {
            vehicleMetricsHistory[vehicle.UUID][metric.id].push(value);
            if (vehicleMetricsHistory[vehicle.UUID][metric.id].length > 5) {
              vehicleMetricsHistory[vehicle.UUID][metric.id].shift();
            }
          }
        });
        
        const status = STATUS_MAP[vehicle.state] || { 
          text: vehicle.state, 
          class: 'status-available', 
          icon: 'ğŸš—' 
        };
        
        const row = document.createElement('tr');
        row.dataset.uuid = vehicle.UUID;
        row.innerHTML = `
          <td title="${vehicle.UUID}">${vehicle.UUID.substring(0, 8)}...</td>
          <td><span style="opacity: 0.9;">ğŸšš</span> è´§è½¦</td>
          <td><span class="vehicle-status ${status.class}">${status.text}</span></td>
          <td><strong>${vehicle.metrics.completedOrders || 0}</strong></td>
        `;
        
        row.addEventListener('click', function() {
          showVehicleDetail(vehicle);
        });
        
        tbody.appendChild(row);
      });
      
      // æ›´æ–°æ•£ç‚¹å›¾
      updateScatterChart();
    }

    // æ˜¾ç¤ºè½¦è¾†è¯¦æƒ…
    function showVehicleDetail(vehicle) {
      // æ˜¾ç¤ºè½¦è¾†è¯¦æƒ…ï¼Œéšè—åˆ—è¡¨
      vehicleListContainer.style.display = 'none';
      vehicleDetailContainer.style.display = 'block';
      vehicleBackBtn.style.display = 'block';
      
      // éšè—è½¦è¾†æŒ‡æ ‡å›¾è¡¨
      hideVehicleMetricChart();
      
      // è®¾ç½®è½¦è¾†æ ‡é¢˜å’ŒçŠ¶æ€
      document.getElementById('vehicle-detail-title').querySelector('span').textContent = 
        `è½¦è¾† ${vehicle.UUID.substring(0, 8)}...`;
        
      const status = STATUS_MAP[vehicle.state] || { class: 'status-available' };
      const statusBadge = document.getElementById('vehicle-status-badge');
      statusBadge.className = `vehicle-status ${status.class}`;
      statusBadge.textContent = STATUS_MAP[vehicle.state]?.text || 'æœªçŸ¥';
      
      // ç”ŸæˆæŒ‡æ ‡å¡ç‰‡
      const metricsGrid = document.getElementById('vehicle-metrics-grid');
      metricsGrid.innerHTML = '';
      
      VEHICLE_METRICS.forEach(metric => {
        const value = vehicle.metrics[metric.id] || 0;
        let formattedValue = value;
        let displayUnit = metric.unit;
        
        if (typeof value === 'number') {
          if (metric.id.includes('Rate') || metric.id.includes('utilization')) {
            formattedValue = (value * 100).toFixed(2);
            displayUnit = '%';
          } else {
            formattedValue = value.toFixed(2);
          }
        }
        
        const metricCard = document.createElement('div');
        metricCard.className = 'metric-card';
        metricCard.style.borderLeft = `3px solid ${metric.borderColor}`;
        metricCard.dataset.metricId = metric.id;
        metricCard.innerHTML = `
          <h4>${metric.name}</h4>
          <div>
            <span class="value">${formattedValue}</span>
            <span class="unit">${displayUnit}</span>
          </div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºè¯¥æŒ‡æ ‡çš„æŠ˜çº¿å›¾
        metricCard.addEventListener('click', function() {
          showVehicleMetricChart(vehicle.UUID, metric.id, metric.name);
        });
        
        metricsGrid.appendChild(metricCard);
      });
    }

    // æ˜¾ç¤ºè½¦è¾†æŒ‡æ ‡æŠ˜çº¿å›¾
    function showVehicleMetricChart(vehicleId, metricId, metricName) {
      // éšè—æŒ‡æ ‡ç½‘æ ¼ï¼Œæ˜¾ç¤ºå›¾è¡¨å®¹å™¨
      document.getElementById('vehicle-metrics-grid').style.display = 'none';
      vehicleMetricChartContainer.style.display = 'block';
      
      // æ›´æ–°å›¾è¡¨æ ‡é¢˜
      document.getElementById('vehicle-metric-chart-title').textContent = `${metricName} - å†å²è¶‹åŠ¿`;
      
      const historyData = vehicleMetricsHistory[vehicleId]?.[metricId] || [];
      const labels = Array.from({length: historyData.length}, (_, i) => 
        `å‘¨æœŸ ${currentPeriod - historyData.length + i + 1}`);
      
      const ctx = document.getElementById('vehicle-metric-chart').getContext('2d');
      
      // é”€æ¯ç°æœ‰å›¾è¡¨
      if (vehicleMetricChart) {
        vehicleMetricChart.destroy();
      }
      
      // è®¡ç®—å›¾è¡¨èŒƒå›´
      const maxValue = Math.max(...historyData);
      const minValue = Math.min(...historyData);
      const paddingTop = maxValue * 0.2;
      const paddingBottom = minValue > 0 ? minValue * 0.2 : 0;
      
      const metricConfig = VEHICLE_METRICS.find(m => m.id === metricId);
      
      vehicleMetricChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['å‘¨æœŸ 1'],
          datasets: [{
            label: metricName,
            data: historyData.length > 0 ? historyData : [0],
            borderColor: metricConfig?.borderColor || '#3498db',
            backgroundColor: metricConfig?.color || 'rgba(52, 152, 219, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'å‘¨æœŸæ•°'
              },
              min: Math.max(1, currentPeriod - 4),
              max: currentPeriod
            },
            y: {
              title: {
                display: true,
                text: metricConfig?.unit || ''
              },
              beginAtZero: minValue >= 0,
              suggestedMin: Math.max(0, minValue - paddingBottom),
              suggestedMax: maxValue + paddingTop
            }
          },
          plugins: {
            legend: {
              display: true
            }
          }
        }
      });
    }

    // æ›´æ–°æœåŠ¡è´¨é‡æŒ‡æ ‡
    function updateServiceQualityMetrics(data) {
      const metricsGrid = document.getElementById('service-quality-metrics-grid');
      if (!metricsGrid) return;
      
      metricsGrid.innerHTML = '';
      
      SERVICE_QUALITY_METRICS.forEach(metric => {
        const value = data[metric.id] || 0;
        let formattedValue = value;
        let displayUnit = metric.unit;
        
        if (typeof value === 'number') {
          if (metric.id.includes('Rate')) {
            formattedValue = (value * 100).toFixed(2);
            displayUnit = '%';
          } else {
            formattedValue = value.toFixed(2);
          }
        }
        
        const metricCard = document.createElement('div');
        metricCard.className = 'system-metric-card';
        metricCard.dataset.metricId = metric.id;
        metricCard.style.borderLeft = `3px solid ${metric.borderColor}`;
        metricCard.innerHTML = `
          <h4>${metric.name}</h4>
          <div>
            <span class="value">${formattedValue}</span>
            <span class="unit">${displayUnit}</span>
          </div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºè¯¥æŒ‡æ ‡çš„æŠ˜çº¿å›¾
        metricCard.addEventListener('click', function() {
          showServiceQualityMetricChart(metric.id, metric.name);
        });
        
        metricsGrid.appendChild(metricCard);
      });
      
      // æ›´æ–°æœåŠ¡è´¨é‡å›¾è¡¨
      updateServiceQualityChart();
    }

    // æ˜¾ç¤ºæœåŠ¡è´¨é‡æŒ‡æ ‡æŠ˜çº¿å›¾
    function showServiceQualityMetricChart(metricId, metricName) {
      // éšè—æŒ‡æ ‡ç½‘æ ¼å’Œä¸»å›¾è¡¨ï¼Œæ˜¾ç¤ºå•ä¸ªæŒ‡æ ‡å›¾è¡¨
      serviceQualityMetricsContainer.style.display = 'none';
      serviceQualityMetricChartContainer.style.display = 'block';
      serviceQualityBackBtn.style.display = 'block';
      
      // æ›´æ–°å›¾è¡¨æ ‡é¢˜
      document.getElementById('service-quality-metric-chart-title').textContent = `${metricName} - å†å²è¶‹åŠ¿`;
      
      const historyData = serviceQualityHistory[metricId] || [];
      const labels = Array.from({length: historyData.length}, (_, i) => 
        `å‘¨æœŸ ${currentPeriod - historyData.length + i + 1}`);
      
      const ctx = document.getElementById('service-quality-metric-chart').getContext('2d');
      
      // é”€æ¯ç°æœ‰å›¾è¡¨
      if (serviceQualityMetricChart) {
        serviceQualityMetricChart.destroy();
      }
      
      // è®¡ç®—å›¾è¡¨èŒƒå›´
      const maxValue = Math.max(...historyData);
      const minValue = Math.min(...historyData);
      const paddingTop = maxValue * 0.2;
      const paddingBottom = minValue > 0 ? minValue * 0.2 : 0;
      
      const metricConfig = SERVICE_QUALITY_METRICS.find(m => m.id === metricId);
      
      serviceQualityMetricChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['å‘¨æœŸ 1'],
          datasets: [{
            label: metricName,
            data: historyData.length > 0 ? historyData : [0],
            borderColor: metricConfig?.borderColor || '#3498db',
            backgroundColor: metricConfig?.color || 'rgba(52, 152, 219, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'å‘¨æœŸæ•°'
              },
              min: Math.max(1, currentPeriod - 4),
              max: currentPeriod
            },
            y: {
              title: {
                display: true,
                text: metricConfig?.unit || ''
              },
              beginAtZero: minValue >= 0,
              suggestedMin: Math.max(0, minValue - paddingBottom),
              suggestedMax: maxValue + paddingTop
            }
          }
        }
      });
    }

    // æ›´æ–°ç³»ç»ŸæŒ‡æ ‡
    function updateSystemMetrics(data) {
      // è®¡ç®—ç³»ç»ŸæŒ‡æ ‡
      const totalTransportCount = vehicles.reduce((sum, v) => sum + (v.metrics.completedOrders || 0), 0);
      const totalWeight = vehicles.reduce((sum, v) => sum + (v.metrics.totalWeight || 0), 0);
      const totalEmptyMileage = vehicles.reduce((sum, v) => sum + (v.metrics.emptyDistance || 0), 0);
      const totalUtilization = vehicles.reduce((sum, v) => sum + (v.metrics.mileage_utilization_rate || 0), 0);
      const avgUtilization = vehicles.length > 0 ? totalUtilization / vehicles.length : 0;
      
      // æ€»ä»£ä»·è®¡ç®—ï¼ˆå‡è®¾ä¸ºæ€»ç¢³æ’æ”¾ï¼‰
      const totalCost = vehicles.reduce((sum, v) => sum + (v.metrics.carbonEmission || 0), 0);
      
      // åˆå¹¶ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡å’Œè®¡ç®—æŒ‡æ ‡
      const systemData = {
        ...data,
        totalCost,
        totalTransportCount,
        totalWeight,
        totalEmptyMileage,
        avgUtilization
      };
      
      // æ›´æ–°ç³»ç»ŸæŒ‡æ ‡ç½‘æ ¼
      const metricsGrid = document.getElementById('system-metrics-grid');
      metricsGrid.innerHTML = '';
      
      const systemDisplayMetrics = [
        ...SYSTEM_METRICS,
        { id: 'totalCost', name: 'ç³»ç»Ÿæ€»ä»£ä»·', unit: 'å¨', color: 'rgba(52, 152, 219, 0.8)', borderColor: '#3498db' },
        { id: 'totalTransportCount', name: 'æ€»è¿è¾“æ¬¡æ•°', unit: 'æ¬¡', color: 'rgba(46, 204, 113, 0.8)', borderColor: '#2ecc71' },
        { id: 'totalWeight', name: 'æ€»è¿é‡', unit: 'å¨', color: 'rgba(241, 196, 15, 0.8)', borderColor: '#f1c40f' },
        { id: 'totalEmptyMileage', name: 'æ€»ç©ºè½½é‡Œç¨‹', unit: 'åƒç±³', color: 'rgba(231, 76, 60, 0.8)', borderColor: '#e74c3c' },
        { id: 'avgUtilization', name: 'å¹³å‡åˆ©ç”¨ç‡', unit: '', color: 'rgba(230, 126, 34, 0.8)', borderColor: '#e67e22' }
      ];
      
      systemDisplayMetrics.forEach(metric => {
        const value = systemData[metric.id] || 0;
        let formattedValue = value;
        let displayUnit = metric.unit;
        
        if (typeof value === 'number') {
          if (metric.id.includes('Utilization')) {
            formattedValue = (value * 100).toFixed(2);
            displayUnit = '%';
          } else {
            formattedValue = value.toFixed(2);
          }
        }
        
        const metricCard = document.createElement('div');
        metricCard.className = 'system-metric-card';
        metricCard.dataset.metricId = metric.id;
        metricCard.style.borderLeft = `3px solid ${metric.borderColor}`;
        metricCard.innerHTML = `
          <h4>${metric.name}</h4>
          <div>
            <span class="value">${formattedValue}</span>
            <span class="unit">${displayUnit}</span>
          </div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºè¯¥æŒ‡æ ‡çš„æŠ˜çº¿å›¾
        metricCard.addEventListener('click', function() {
          showSystemMetricChart(metric.id, metric.name);
        });
        
        metricsGrid.appendChild(metricCard);
      });
      
      // æ›´æ–°å›¾è¡¨
      updateSystemChart();
    }
    
    // æ˜¾ç¤ºç³»ç»ŸæŒ‡æ ‡æŠ˜çº¿å›¾
    function showSystemMetricChart(metricId, metricName) {
      // éšè—ç³»ç»ŸæŒ‡æ ‡ç½‘æ ¼å’Œä¸»å›¾è¡¨ï¼Œæ˜¾ç¤ºå•ä¸ªæŒ‡æ ‡å›¾è¡¨
      systemMetricsContainer.style.display = 'none';
      metricChartContainer.style.display = 'block';
      systemBackBtn.style.display = 'block';
      
      // æ›´æ–°å›¾è¡¨æ ‡é¢˜
      document.getElementById('metric-chart-title').textContent = `${metricName} - å†å²è¶‹åŠ¿`;
      
      const historyData = systemMetricsHistory[metricId] || [];
      const labels = Array.from({length: historyData.length}, (_, i) => 
        `å‘¨æœŸ ${currentPeriod - historyData.length + i + 1}`);
      
      const ctx = document.getElementById('metric-chart').getContext('2d');
      
      // é”€æ¯ç°æœ‰å›¾è¡¨
      if (metricChart) {
        metricChart.destroy();
      }
      
      // è®¡ç®—å›¾è¡¨èŒƒå›´
      const maxValue = Math.max(...historyData);
      const minValue = Math.min(...historyData);
      const paddingTop = maxValue * 0.2;
      const paddingBottom = minValue > 0 ? minValue * 0.2 : 0;
      
      const metricConfig = [...SYSTEM_METRICS, 
        { id: 'totalCost', name: 'ç³»ç»Ÿæ€»ä»£ä»·', unit: 'å¨', borderColor: '#3498db' },
        { id: 'totalTransportCount', name: 'æ€»è¿è¾“æ¬¡æ•°', unit: 'æ¬¡', borderColor: '#2ecc71' },
        { id: 'totalWeight', name: 'æ€»è¿é‡', unit: 'å¨', borderColor: '#f1c40f' },
        { id: 'totalEmptyMileage', name: 'æ€»ç©ºè½½é‡Œç¨‹', unit: 'åƒç±³', borderColor: '#e74c3c' },
        { id: 'avgUtilization', name: 'å¹³å‡åˆ©ç”¨ç‡', unit: '', borderColor: '#e67e22' }
      ].find(m => m.id === metricId);
      
      metricChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.length > 0 ? labels : ['å‘¨æœŸ 1'],
          datasets: [{
            label: metricName,
            data: historyData.length > 0 ? historyData : [0],
            borderColor: metricConfig?.borderColor || '#3498db',
            backgroundColor: metricConfig?.color || 'rgba(52, 152, 219, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'å‘¨æœŸæ•°'
              },
              min: Math.max(1, currentPeriod - 4),
              max: currentPeriod
            },
            y: {
              title: {
                display: true,
                text: metricConfig?.unit || ''
              },
              beginAtZero: minValue >= 0,
              suggestedMin: Math.max(0, minValue - paddingBottom),
              suggestedMax: maxValue + paddingTop
            }
          }
        }
      });
    }

    // æ›´æ–°æ•£ç‚¹å›¾
    function updateScatterChart() {
      const scatterMetric = SCATTER_METRICS[currentScatterMetric];
      if (!scatterMetric || !scatterChart) return;
      
      const scatterData = vehicles.map(vehicle => ({
        x: vehicle.metrics[scatterMetric.xAxis] || 0,
        y: vehicle.metrics[scatterMetric.yAxis] || 0,
        label: vehicle.UUID.substring(0, 6)
      }));
      
      // è®¡ç®—åæ ‡è½´èŒƒå›´
      const xValues = scatterData.map(d => d.x);
      const yValues = scatterData.map(d => d.y);
      const maxX = Math.max(...xValues);
      const minX = Math.min(...xValues);
      const maxY = Math.max(...yValues);
      const minY = Math.min(...yValues);
      
      const paddingX = maxX * 0.2;
      const paddingY = maxY * 0.2;
      
      scatterChart.data.datasets[0].data = scatterData;
      scatterChart.options.scales.x.title.text = scatterMetric.xLabel;
      scatterChart.options.scales.y.title.text = scatterMetric.yLabel;
      
      // è®¾ç½®åæ ‡è½´èŒƒå›´
      scatterChart.options.scales.x.suggestedMin = minX - paddingX;
      scatterChart.options.scales.x.suggestedMax = maxX + paddingX;
      scatterChart.options.scales.y.suggestedMin = minY - paddingY;
      scatterChart.options.scales.y.suggestedMax = maxY + paddingY;
      
      scatterChart.update();
    }

    // åˆå§‹åŒ–å›¾è¡¨
    function initCharts() {
      // ç³»ç»Ÿå›¾è¡¨
      const systemCtx = document.getElementById('system-chart').getContext('2d');
      systemChart = new Chart(systemCtx, {
        type: 'bar',
        data: {
          labels: periodLabels,
          datasets: SYSTEM_METRICS.map(metric => ({
            label: metric.name,
            data: [],
            backgroundColor: metric.color,
            borderColor: metric.borderColor,
            borderWidth: 1
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
      
      // æ•£ç‚¹å›¾
      const scatterCtx = document.getElementById('scatter-chart').getContext('2d');
      scatterChart = new Chart(scatterCtx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'è½¦è¾†',
            data: [],
            backgroundColor: 'rgba(52, 152, 219, 0.7)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 1,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: {
                display: true,
                text: 'Xè½´'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Yè½´'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `è½¦è¾†: ${context.raw.label}`;
                }
              }
            }
          }
        }
      });
      
      // æœåŠ¡è´¨é‡å›¾è¡¨
      const serviceQualityCtx = document.getElementById('service-quality-chart').getContext('2d');
      serviceQualityChart = new Chart(serviceQualityCtx, {
        type: 'bar',
        data: {
          labels: periodLabels,
          datasets: SERVICE_QUALITY_METRICS.map(metric => ({
            label: metric.name,
            data: [],
            backgroundColor: metric.color,
            borderColor: metric.borderColor,
            borderWidth: 1
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // æ›´æ–°ç³»ç»Ÿå›¾è¡¨
    function updateSystemChart() {
      if (!systemChart) return;
      
      SYSTEM_METRICS.forEach((metric, index) => {
        const historyData = systemMetricsHistory[metric.id] || [];
        systemChart.data.datasets[index].data = historyData;
      });
      
      // æ›´æ–°å‘¨æœŸæ ‡ç­¾
      const historyLength = systemMetricsHistory[SYSTEM_METRICS[0]?.id]?.length || 5;
      const labels = Array.from({length: historyLength}, (_, i) => 
        `å‘¨æœŸ ${currentPeriod - historyLength + i + 1}`);
      
      systemChart.data.labels = labels;
      systemChart.update();
    }

    // æ›´æ–°æœåŠ¡è´¨é‡å›¾è¡¨
    function updateServiceQualityChart() {
      if (!serviceQualityChart) return;
      
      SERVICE_QUALITY_METRICS.forEach((metric, index) => {
        const historyData = serviceQualityHistory[metric.id] || [];
        serviceQualityChart.data.datasets[index].data = historyData;
      });
      
      // æ›´æ–°å‘¨æœŸæ ‡ç­¾
      const historyLength = serviceQualityHistory[SERVICE_QUALITY_METRICS[0]?.id]?.length || 5;
      const labels = Array.from({length: historyLength}, (_, i) => 
        `å‘¨æœŸ ${currentPeriod - historyLength + i + 1}`);
      
      serviceQualityChart.data.labels = labels;
      serviceQualityChart.update();
    }

    // æ˜¾ç¤ºæ›´æ–°æç¤º
    function showUpdateNotification() {
      updateNotification.classList.add('show');
      setTimeout(() => {
        updateNotification.classList.remove('show');
      }, 2000);
    }
  </script>
</body>
</html>
